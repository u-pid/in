
<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>게시글 보기 - 유피드 밴블리온</title>
  <style>
    /* --- (원본 CSS를 그대로 유지, 사이트 스타일 100% 일치) --- */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; background-color: #1c1c1c; color: #fff; font-family: Arial, sans-serif; -webkit-font-smoothing:antialiased; }

    .site-content {
      width: 100%;
      max-width: 970px;
      margin: 0 auto;
      padding: 0 12px;
    }

    header {
      background-color: #003d80;
      color: white;
      padding: 11px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .logo { font-size: 19.8px; font-weight: bold; }
    header .auth-buttons a { color: white; text-decoration: none; margin-left: 15px; font-weight: bold; font-size: 15.4px; transition: color .3s; cursor:pointer; }
    header .auth-buttons a:hover { color: #ffcc00; }

    /* 게시글 박스 스타일 */
    .post-wrap {
      margin: 30px auto;
      /* 배경/테두리/그림자 제거 요청에 따라 아래 세 속성만 변경했습니다.
         padding과 position 등 레이아웃 속성은 원본 그대로 유지합니다. */
      background: transparent;
      border-radius: 0;
      box-shadow: none;
      padding: 22px;
      position: relative; /* for options button */
    }
    .post-meta { color:#ccc; font-size:13px; margin-bottom:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .author-block { display:flex; gap:12px; align-items:center; cursor:pointer; }
    .author-avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,0.06); background:#111; flex:0 0 auto; }
    .post-title { font-size:22px; color:#ffea8a; margin:8px 0 8px 0; word-break:break-word; }
    .post-author { color:#ddd; font-weight:700; display:inline-flex; gap:8px; align-items:center; }
    .role-tag { background:#ffcc00; color:#000; padding:3px 8px; border-radius:8px; font-weight:700; font-size:12px; }
    .post-date { color:#bbb; font-size:13px; }
    .post-content { color:#eaeaea; margin-top:16px; line-height:1.7; white-space:pre-wrap; word-break:break-word; }
    .post-actions { margin-top:18px; display:flex; gap:10px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; background:transparent; color:#ddd; border:1px solid rgba(255,255,255,0.06); cursor:pointer; font-weight:700; }
    .btn.primary { background: linear-gradient(90deg,#0f61b0,#0a3e7a); color:#fff; border:1px solid rgba(255,255,255,0.03); }

    /* three-dot menu */
    .post-options-btn { position:absolute; top:12px; right:12px; background:transparent; border:0; color:#ddd; font-size:20px; cursor:pointer; padding:6px; border-radius:8px; }
    .post-options-btn:hover { background: rgba(255,255,255,0.02); color:#fff; }
    .post-options-menu { position:absolute; top:44px; right:12px; background:#222; border:1px solid rgba(255,255,255,0.04); border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,0.6); overflow:hidden; display:none; z-index:2000; min-width:160px; }
    .post-options-menu button { width:100%; text-align:left; padding:10px 12px; border:0; background:transparent; color:#ddd; cursor:pointer; font-weight:700; }
    .post-options-menu button:hover { background: rgba(255,255,255,0.02); color:#fff; }

    /* admin small edit buttons */
    .admin-edit-btn { margin-left:8px; padding:4px 6px; font-size:12px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ddd; border-radius:6px; cursor:pointer; }

    /* pinned tag - reduced size (changed per 요청) */
    .pinned-tag { background:#ffea8a; color:#000; padding:2px 4px; border-radius:4px; font-weight:700; margin-right:8px; font-size:11px; }

    /* 댓글 영역 */
    .comments-wrap { margin-top:22px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .comment-form { display:flex; gap:10px; align-items:flex-start; margin-bottom:12px; }
    .comment-input { flex:1; min-height:48px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.35); color:#fff; resize:vertical; }
    .comment-submit { padding:8px 12px; border-radius:8px; background:#0f61b0; color:#fff; border:0; cursor:pointer; font-weight:700; }

    .comment-item { display:flex; gap:10px; padding:10px 6px; border-bottom:1px solid rgba(255,255,255,0.02); align-items:flex-start; }
    .comment-author-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,0.04); background:#111; flex:0 0 auto; }
    .comment-body { flex:1; }
    .comment-head { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .comment-author-name { font-weight:700; color:#fff; font-size:14px; }
    .comment-date { color:#bbb; font-size:12px; margin-left:6px; }
    .comment-content { color:#e6e6e6; font-size:14px; line-height:1.5; white-space:pre-wrap; word-break:break-word; }
    .comment-actions { margin-top:8px; display:flex; gap:10px; align-items:center; }
    .like-btn { background:transparent; border:0; color:#ddd; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:8px; }
    .like-btn.liked { color:#ffae42; }

    /* 관리자 제어바 제거 — (원래 있던 스타일은 유지되나 요소는 제거) */

    /* 로그인/회원가입 모달, pw-toggle 등 원본 스타일 유지 */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
    .modal-content { width:420px; max-width: calc(100% - 40px); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; color:white; box-shadow:0 10px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); backdrop-filter: blur(6px) saturate(120%); display:flex; flex-direction:column; gap:12px; }
    .modal-close { position: absolute; top: 10px; right: 10px; background: transparent; color: #ddd; border: none; cursor: pointer; font-size: 20px; padding: 6px; border-radius: 8px; transition: background .15s, color .15s; z-index: 1010; }
    .modal-close:hover { background: rgba(255,255,255,0.02); color:#fff; }
    .modal-inner { display:flex; gap:12px; align-items:center; }
    .modal-brand img { width:56px; height:56px; border-radius:8px; flex:0 0 auto; }

    .field { display:block; margin-top:8px; width:100%; }
    input[type="email"], input[type="password"], input[type="text"] { width:100%; margin:8px 0 0 0; padding:12px 44px 12px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.4); color:#fff; outline:none; font-size:14px; box-sizing:border-box; }

    .password-field { position: relative; }
    .password-field .pw-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #ddd;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pw-toggle svg { width:18px; height:18px; display:block; }
    .pw-toggle .icon-eye-off { display: none; }

    .modal-actions { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; }
    .alt-btn { flex:1; padding:8px 10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ddd; border-radius:8px; font-size:13px; cursor:pointer; }
    .primary-btn { width:100%; background: linear-gradient(90deg,#0f61b0,#0a3e7a); color:#fff; box-shadow:0 6px 18px rgba(15,97,176,0.16); border:1px solid rgba(255,255,255,0.03); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:bold; }

    /* Profile modal specific */
    .profile-modal .modal-content { width:720px; max-width: calc(100% - 40px); padding:0; overflow:hidden; }
    .profile-top { position:relative; height:160px; background:#111; display:flex; align-items:flex-end; }
    .profile-banner { width:100%; height:100%; object-fit:cover; display:block; }
    .profile-top-inner { position:absolute; left:18px; bottom:-34px; display:flex; gap:16px; align-items:center; }
    .profile-top-inner .profile-avatar { width:120px; height:120px; border-radius:50%; border:3px solid #111; object-fit:cover; background:#222; }
    .profile-top-inner .profile-meta { color:#fff; }
    .profile-nick { font-size:20px; font-weight:800; display:flex; gap:8px; align-items:center; }
    .profile-role { background:#ffcc00; color:#000; padding:4px 8px; border-radius:8px; font-weight:700; font-size:12px; }
    .profile-bio { font-size:13px; color:#ddd; margin-top:6px; max-width:520px; }

    .profile-body { padding:54px 18px 18px 18px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); }
    .profile-stats { display:flex; gap:12px; align-items:center; }
    .profile-stats .stat { font-weight:700; color:#fff; }
    .profile-actions { margin-left:auto; }
    .follow-btn { padding:8px 12px; border-radius:8px; background:#0f61b0; color:#fff; border:0; cursor:pointer; font-weight:800; }

    .activity-note { text-align:center; color:#bbb; font-size:13px; padding:14px 0; border-top:1px dashed rgba(255,255,255,0.03); }

    footer { background:#111; color:#ccc; font-size:12px; padding:20px; text-align:center; line-height:1.5; margin-top:40px; }
    footer a { color:#ccc; text-decoration:none; margin:0 4.5px; }
    @media (max-width:600px) {
      .post-title { font-size:18px; }
      .post-wrap { padding:16px; margin:18px 12px; }
      .author-avatar { width:40px; height:40px; }
      .profile-modal .modal-content { width:calc(100% - 20px); }
    }
  </style>
</head>
<body>

  <!-- === header (원본과 동일) === -->
  <header>
    <a href="index.html" class="logo" aria-label="홈으로 이동" style="color:inherit; text-decoration:none;">BANBLE LEON</a>
    <div class="auth-buttons">
      <a onclick="openModal('loginModal')">로그인</a>
      <a onclick="openModal('signupModal')">회원가입</a>
      <a id="logoutBtn" style="display:none;cursor:pointer;">로그아웃</a>
      <span id="userName" style="margin-left:15px; font-weight:bold; color:#ffcc00; display:none;"></span>
    </div>
  </header>

  <!-- (관리자 제어바 제거됨) -->

  <!-- === main content: 게시글 뷰어만 남김 === -->
  <div class="site-content">
    <div class="post-wrap" id="postWrap" aria-live="polite">

      <!-- options button -->
      <button id="postOptionsBtn" class="post-options-btn" aria-haspopup="true" aria-expanded="false" title="더보기">⋯</button>
      <div id="postOptionsMenu" class="post-options-menu" role="menu" aria-hidden="true">
        <button id="copyLinkBtn" type="button" role="menuitem">게시글 링크 복사</button>
      </div>

      <!-- 작성자 프로필/이름/날짜 (요청: 제목 위로) -->
      <div class="post-meta" style="margin-bottom:6px;">
        <div class="author-block" style="flex:1;" id="authorBlock" role="button" tabindex="0" aria-label="작성자 프로필 보기">
          <img id="authorAvatar" class="author-avatar" src="https://via.placeholder.com/48?text=?" alt="작성자 프로필">
          <div>
            <div id="author" class="post-author"></div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div id="createdAt" class="post-date"></div>
              <!-- 조회수 옆에 관리자 편집 버튼 추가 (id=adminEditViewsBtn) -->
              <div id="postViewCount" class="post-date" style="margin-left:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- 제목 (아래로 이동) -->
      <h1 class="post-title" id="title">로딩 중...</h1>

      <div class="post-content" id="content">게시글 내용을 불러오는 중입니다.</div>

      <!-- 이미지 갤러리 (이미지를 가로폭에 맞게 크게 표시) -->
      <div id="imageGallery" style="margin-top:16px; display:flex; gap:8px; flex-direction:column;"></div>

      <!-- 좋아요 버튼 및 북마크 버튼 (요청: 내용/이미지 아래로 이동) -->
      <div style="margin-top:16px; display:flex; gap:10px; align-items:center;">
        <button id="postLikeBtn" class="btn" title="좋아요"><span id="postLikeLabel">좋아요</span> <span id="postLikeCount" style="margin-left:8px;color:#ffae42;">0</span><button id="adminEditLikesBtn" class="admin-edit-btn" style="display:none;">편집</button></button>
        <button id="postBookmarkBtn" class="btn" title="북마크"><span id="postBookmarkLabel">북마크</span> <span id="postBookmarkCount" style="margin-left:8px;color:#ffae42;">0</span><button id="adminEditBookmarksBtn" class="admin-edit-btn" style="display:none;">편집</button></button>
      </div>

      <!-- 댓글 섹션 -->
      <div class="comments-wrap" id="commentsWrap" aria-live="polite">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:800; color:#ffae42;">댓글</div>
          <div id="commentsCount" style="color:#bbb;">0</div>
        </div>

        <div id="commentFormArea" style="margin-bottom:12px;">
          <div class="comment-form">
            <textarea id="commentInput" class="comment-input" placeholder="댓글을 작성하려면 로그인 후 입력하세요." rows="2" disabled></textarea>
            <button id="commentSubmit" class="comment-submit">등록</button>
          </div>
        </div>

        <div id="commentsList"></div>
      </div>

      <div class="post-actions" id="postActions" style="display:none;">
        <!-- 추가 액션 버튼들(로그인한 작성자에게 노출 등)은 여기 넣을 수 있습니다 -->
      </div>
    </div>
  </div>

  <!-- === 로그인 모달 (원본과 동일) === -->
  <div id="loginModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="loginTitle">
    <div class="modal-content" role="document">
      <button class="modal-close" onclick="closeModal('loginModal')" aria-label="닫기">&times;</button>
      <div class="modal-inner">
        <div class="modal-brand">
          <img src="https://i.imgur.com/FzKC3OX.png" alt="브랜드" style="width:56px;height:56px;border-radius:8px;">
          <div>
            <h2 id="loginTitle">로그인</h2>
            <p>계정으로 로그인하여 유피드 홀을 이용하세요.</p>
          </div>
        </div>
      </div>

      <div>
        <label class="field">
          <input type="email" id="loginEmail" placeholder="이메일" />
        </label>

        <label class="field password-field">
          <input type="password" id="loginPass" placeholder="비밀번호" />
          <button type="button" class="pw-toggle" data-target="loginPass" aria-label="비밀번호 보기" title="비밀번호 보기">
            <svg class="icon-eye" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M1.5 12C1.5 12 5.5 4 12 4s10.5 8 10.5 8-4 8-10.5 8S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17.94 17.94C16.31 19.05 14.24 19.74 12 19.74 6.5 19.74 2 12 2 12s2.41-3.32 6.07-5.24" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9.88 9.88A3 3 0 0114.12 14.12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </label>

        <div class="modal-actions">
          <label style="font-size:13px;color:#ccc;"><input type="checkbox" id="rememberMe" style="margin-right:6px;"/> 로그인 유지</label>
        </div>

        <button id="loginSubmit" class="primary-btn">로그인</button>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="openSignupFromLogin" class="alt-btn" type="button">계정 만들기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === 회원가입 모달 (원본과 동일) === -->
  <div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="signupTitle">
    <div class="modal-content" role="document">
      <button class="modal-close" onclick="closeModal('signupModal')" aria-label="닫기">&times;</button>
      <div class="modal-inner">
        <div class="modal-brand">
          <img src="https://i.imgur.com/5fdGvm7.png" alt="회원가입" style="width:56px;height:56px;border-radius:8px;">
          <div>
            <h2 id="signupTitle">유피드 계정 생성</h2>
            <p>밴블리온의 유피드 서비스에 가입하세요</p>
          </div>
        </div>
      </div>

      <div>
        <label class="field">
          <input type="text" id="signupNickname" placeholder="닉네임" />
        </label>
        <label class="field">
          <input type="email" id="signupEmail" placeholder="이메일" />
        </label>
        <label class="field password-field">
          <input type="password" id="signupPass" placeholder="비밀번호" />
          <button type="button" class="pw-toggle" data-target="signupPass" aria-label="비밀번호 보기" title="비밀번호 보기">
            <svg class="icon-eye" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M1.5 12C1.5 12 5.5 4 12 4s10.5 8 10.5 8-4 8-10.5 8S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17.94 17.94C16.31 19.05 14.24 19.74 12 19.74 6.5 19.74 2 12 2 12s2.41-3.32 6.07-5.24" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9.88 9.88A3 3 0 0114.12 14.12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </label>

        <button id="signupSubmit" class="primary-btn">회원가입</button>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="openLoginFromSignup" class="alt-btn" type="button">로그인 하기</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === Profile Modal (새로 추가) === -->
  <div id="profileModal" class="modal profile-modal" aria-hidden="true" role="dialog" aria-labelledby="profileTitle">
    <div class="modal-content" role="document" style="position:relative;">
      <button class="modal-close" onclick="closeModal('profileModal')" aria-label="닫기">&times;</button>

      <div class="profile-top" aria-hidden="false">
        <img id="profileBanner" class="profile-banner" src="https://via.placeholder.com/720x160?text=Banner" alt="프로필 배너">
        <div class="profile-top-inner">
          <img id="profileAvatar" class="profile-avatar profile-avatar" src="https://via.placeholder.com/68?text=?" alt="프로필 사진">
          <div class="profile-meta">
            <div class="profile-nick" id="profileNickname">사용자</div>
            <div id="profileBio" class="profile-bio">소개가 없습니다.</div>
          </div>
          <div class="profile-actions" style="margin-left:16px;">
            <button id="followBtn" class="follow-btn" style="display:none;">팔로우</button>
          </div>
        </div>
      </div>

      <div class="profile-body" aria-live="polite">
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="profile-stats">
            <!-- 숫자 부분을 span으로 분리하여 전체 element.textContent 덮어쓰기 시 버튼이 사라지지 않도록 변경 -->
            <div class="stat" id="followersCount">팔로워 <span id="followersCountValue">0</span> <button id="adminEditFollowersBtn" class="admin-edit-btn" style="display:none;">편집</button></div>
            <div class="stat" id="followingCount">팔로잉 <span id="followingCountValue">0</span> <button id="adminEditFollowingBtn" class="admin-edit-btn" style="display:none;">편집</button></div>
          </div>
        </div>

        <div style="margin-top:6px;">
          <div style="font-weight:700; margin-bottom:6px;">활동 탭</div>
          <div style="font-size:13px; color:#bbb;">(멤버의 활동 데시보드 탭은 승인된 IP에게 제공되는 기능입니다.)</div>
        </div>

        <div class="activity-note">활동 관련 기능은 현재 준비중입니다.</div>
      </div>
    </div>
  </div>

  <!-- === footer (원본과 동일) === -->
  <footer>
    <a href="library.html?section=terms">이용약관</a> |
    <a href="library.html?section=privacy">개인정보 처리방침</a> |
    <a href="library.html?section=server">유피드 자산 데이터 서버 지침</a> |
    <a href="library.html?section=notice">밴블리온 운영부 고지 사항</a> |
    <a href="library.html?section=community">커뮤니티 가이드라인</a>

    <div style="margin-top:9px;">
      유피드는 밴블리온 사 프로그램 개발 부서 "에너자이저"의 공식 인트라넷 플랫폼으로, 모든 사이트 내 정보는 사이트 자산사의 목적에 한해 제한되고 관리될 수 있습니다.
    </div>
    <div style="margin-top:9px;">
      경기도 수원시 밴블리온 수원 지부 미공개 위치<br>
      help@upid.org | 오픈 소스 라이선스<br>
      ©UPID Foundation.
    </div>

    <div style="margin-top:15px; display:flex; justify-content:center; flex-wrap:wrap; gap:15px;">
      <img src="https://i.imgur.com/cNs1Eg7.png" alt="Logo1" style="height:30px;">
      <img src="https://i.imgur.com/SF42CN6.png" alt="Logo2" style="height:30px;">
      <img src="https://i.imgur.com/2pz9w9f.png" alt="Logo3" style="height:30px;">
      <img src="https://i.imgur.com/SfRsyh4.png" alt="Logo4" style="height:30px;">
      <img src="https://i.imgur.com/IS5OcvD.png" alt="Logo5" style="height:30px;">
      <img src="https://i.imgur.com/7uI8nfn.png" alt="Logo6" style="height:30px;">
      <img src="https://i.imgur.com/yccwqmB.png" alt="Logo7" style="height:30px;">
      <img src="https://i.imgur.com/mHH406e.png" alt="Logo8" style="height:30px;">
      <img src="https://i.imgur.com/tc4GZfD.png" alt="Logo9" style="height:30px;">
      <div style="width:1px; height:30px; background:#444;"></div>
      <img src="https://i.imgur.com/cHJBLaF.png" alt="Logo10" style="height:30px;">
    </div>
  </footer>

  <!-- === 스크립트: Firebase 초기화, Auth, Firestore, 게시글/댓글/좋아요 로직 === -->
  <script type="module">
    // Firebase 모듈 (버전은 원본의 auth와 맞춰 10.12.2 사용)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      setDoc,
      deleteDoc,
      updateDoc,
      increment,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- firebaseConfig (에란다 제공) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBJZle3txhhthWgaIWTTHzrLl4bkJqQye4",
      authDomain: "fast-gateway-290809.firebaseapp.com",
      projectId: "fast-gateway-290809",
      storageBucket: "fast-gateway-290809.firebasestorage.app",
      messagingSenderId: "640433110514",
      appId: "1:640433110514:web:8fe4fafc9a987b6a4b3f6b",
      measurementId: "G-2V57XWX7CW"
    };

    // 초기화
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- 기본 이미지 (인터넷에서 가져온 기본 그래픽)
    const DEFAULT_AVATAR = "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png";
    const DEFAULT_BANNER = "https://via.placeholder.com/720x160/333333/ffffff?text=Banner";

    // 전역 현재 사용자 참조
    let currentUser = null;
    let isAdmin = false;

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      isAdmin = false;
      if (user) {
        try {
          const uSnap = await getDoc(doc(db, 'users', user.uid));
          if (uSnap.exists()) {
            const ud = uSnap.data();
            if (ud && ud.role && String(ud.role).toLowerCase() === 'admin') isAdmin = true;
          }
        } catch (e) {
          console.error('admin check failed', e);
        }
      }
      updateHeader(user);
      toggleAdminControls(); // show/hide admin UI where needed

      const commentInput = document.getElementById('commentInput');
      const commentSubmit = document.getElementById('commentSubmit');
      if (commentInput && commentSubmit) {
        if (user) {
          commentInput.disabled = false;
          commentInput.placeholder = "댓글을 입력하세요.";
        } else {
          commentInput.disabled = true;
          commentInput.placeholder = "댓글을 작성하려면 로그인 후 입력하세요.";
        }
      }
    });

    // --- 공통 UI 함수 (전역 노출) ---
    window.openModal = function(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "flex";
    };
    window.closeModal = function(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    };

    function updateHeader(user) {
      const userNameEl = document.getElementById("userName");
      const loginBtn = document.querySelector(".auth-buttons a[onclick*='loginModal']");
      const signupBtn = document.querySelector(".auth-buttons a[onclick*='signupModal']");
      const logoutBtn = document.getElementById("logoutBtn");

      if (user) {
        if (loginBtn) loginBtn.style.display = "none";
        if (signupBtn) signupBtn.style.display = "none";
        if (logoutBtn) logoutBtn.style.display = "inline-block";

        if (userNameEl) {
          const name = user.displayName || user.email || "사용자";
          userNameEl.textContent = name;
          userNameEl.style.display = "inline-block";
        }
      } else {
        if (loginBtn) loginBtn.style.display = "inline-block";
        if (signupBtn) signupBtn.style.display = "inline-block";
        if (logoutBtn) logoutBtn.style.display = "none";

        if (userNameEl) {
          userNameEl.textContent = "";
          userNameEl.style.display = "none";
        }
      }
    }

    // --- 회원가입 / 로그인 / 로그아웃 이벤트 바인딩 ---
    document.getElementById("signupSubmit").addEventListener("click", async () => {
      const nickname = document.getElementById("signupNickname").value;
      const email = document.getElementById("signupEmail").value;
      const pass = document.getElementById("signupPass").value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(userCredential.user, { displayName: nickname });
        try {
          const userDocRef = doc(db, 'users', userCredential.user.uid);
          await setDoc(userDocRef, {
            displayName: nickname || null,
            email: email || null,
            photoURL: userCredential.user.photoURL || null,
            createdAt: serverTimestamp()
          }, { merge: true });
        } catch (_) { /* ignore */ }
        updateHeader(userCredential.user);
        alert("회원가입 완료!");
        closeModal("signupModal");
      } catch (error) {
        alert("회원가입 실패: " + error.message);
      }
    });

    document.getElementById("loginSubmit").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, pass);
        updateHeader(userCredential.user);
        alert("로그인 성공!");
        closeModal("loginModal");
      } catch (error) {
        alert("로그인 실패: " + error.message);
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        updateHeader(null);
      } catch (e) {
        console.error(e);
      }
    });

    // --- 게시글 / 댓글 / 좋아요 로직 (동적 post 선택 지원) ---
    let currentPostId = (new URLSearchParams(window.location.search).get('id')) 
                        || (localStorage.getItem('selectedPostId')) 
                        || "osQ0GPHi5GRRFOIRNpW0";

    let currentAuthorId = null;
    // NEW: modal에 로드된 유저의 uid — 프로필 모달 대상 식별용
    let profileModalUserId = null;

    // UI 요소
    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const authorEl = document.getElementById('author');
    const createdAtEl = document.getElementById('createdAt');
    const authorAvatarEl = document.getElementById('authorAvatar');
    const galleryEl = document.getElementById('imageGallery');

    const postLikeBtn = document.getElementById('postLikeBtn');
    const postLikeLabel = document.getElementById('postLikeLabel');
    const postLikeCountEl = document.getElementById('postLikeCount');
    const postBookmarkBtn = document.getElementById('postBookmarkBtn');
    const postBookmarkLabel = document.getElementById('postBookmarkLabel');
    const postBookmarkCountEl = document.getElementById('postBookmarkCount');
    const postViewCountEl = document.getElementById('postViewCount');

    const commentInput = document.getElementById('commentInput');
    const commentSubmit = document.getElementById('commentSubmit');
    const commentsList = document.getElementById('commentsList');
    const commentsCountEl = document.getElementById('commentsCount');

    // post options elements
    const postOptionsBtn = document.getElementById('postOptionsBtn');
    const postOptionsMenu = document.getElementById('postOptionsMenu');
    const copyLinkBtn = document.getElementById('copyLinkBtn');

    // admin elements (추가: views 편집 버튼 참조)
    const adminEditLikesBtn = document.getElementById('adminEditLikesBtn');
    const adminEditBookmarksBtn = document.getElementById('adminEditBookmarksBtn');
    const adminEditFollowersBtn = document.getElementById('adminEditFollowersBtn');
    const adminEditFollowingBtn = document.getElementById('adminEditFollowingBtn');
    // 추가된 버튼을 DOM에 동적으로 생성하여 toggleAdminControls에서 노출 -> 하지만 여기에 참조해두면 안전
    // (postViewCount에 붙일 버튼을 DOM에서 생성/추가)
    let adminEditViewsBtn = null;

    // Profile modal related value spans (새로 추가된 참조)
    const followersCountValueEl = document.getElementById('followersCountValue');
    const followingCountValueEl = document.getElementById('followingCountValue');

    // 상태 및 리스너 해제 핸들
    let postLikeListenerUnsub = null;
    let commentsListenerUnsub = null;
    let postBookmarkListenerUnsub = null;
    let postLikedByCurrentUser = false;
    let postBookmarkedByCurrentUser = false;

    // DOM에 adminEditViewsBtn 없으면 동적으로 생성하여 postViewCount 요소에 추가
    function ensureAdminViewEditBtn() {
      if (adminEditViewsBtn) return adminEditViewsBtn;
      const el = document.createElement('button');
      el.id = 'adminEditViewsBtn';
      el.className = 'admin-edit-btn';
      el.style.display = 'none';
      el.textContent = '편집';
      // append to postViewCountEl (postViewCountEl might contain text)
      if (postViewCountEl) {
        postViewCountEl.appendChild(el);
      }
      adminEditViewsBtn = el;
      // wire event
      adminEditViewsBtn.addEventListener('click', async (ev) => {
        ev.stopPropagation();
        if (!isAdmin) return;
        const current = parseInt((postViewCountEl.textContent || '').replace(/[^0-9]/g,'')) || 0;
        const input = prompt('조회수를 입력하세요 (숫자):', String(current));
        if (input === null) return;
        const n = parseInt(input);
        if (isNaN(n) || n < 0) { alert('유효한 숫자를 입력하세요'); return; }
        await adminSetPostViews(n);
      });
      return adminEditViewsBtn;
    }

    // Load post data once and set up listeners (안전: 이전 리스너 해제)
    async function initPost() {
      try {
        if (postLikeListenerUnsub) { postLikeListenerUnsub(); postLikeListenerUnsub = null; }
        if (commentsListenerUnsub) { commentsListenerUnsub(); commentsListenerUnsub = null; }
        if (postBookmarkListenerUnsub) { postBookmarkListenerUnsub(); postBookmarkListenerUnsub = null; }
      } catch (e) { /* ignore */ }

      titleEl.innerText = '로딩 중...';
      contentEl.innerText = '';
      authorEl.innerText = '';
      createdAtEl.innerText = '';
      authorAvatarEl.src = DEFAULT_AVATAR;
      galleryEl.innerHTML = '';
      commentsList.innerHTML = '';
      commentsCountEl.innerText = '0';
      postLikeCountEl.innerText = '0';
      postBookmarkCountEl.innerText = '0';
      postViewCountEl.innerText = '';
      postLikedByCurrentUser = false;
      postBookmarkedByCurrentUser = false;
      renderPostLikeButton();
      renderPostBookmarkButton();

      try {
        const postDocRef = doc(db, 'gaesi', currentPostId);
        const snap = await getDoc(postDocRef);
        if (!snap.exists()) {
          titleEl.innerText = '게시글을 찾을 수 없습니다.';
          contentEl.innerText = '';
          postViewCountEl.innerText = '';
          document.title = "게시글 보기 - 유피드 밴블리온";
          return;
        }
        const data = snap.data();

        const pageTitle = (data.title && data.title.trim()) ? `${data.title} - 유피드 밴블리온` : '게시글 보기 - 유피드 밴블리온';
        document.title = pageTitle;

        titleEl.innerText = data.title || '(제목 없음)';

        let authorName = data.author || '';
        let authorProfile = data.authorProfileUrl || '';
        currentAuthorId = data.authorId || null;
        if (data.authorId) {
          try {
            const userDoc = await getDoc(doc(db, 'users', data.authorId));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              authorName = userData.displayName || authorName || userData.email || '';
              authorProfile = userData.photoURL || authorProfile || '';
            }
          } catch (e) { /* ignore */ }
        }
        authorEl.innerHTML = '';
        const nameNode = document.createElement('span');
        nameNode.textContent = authorName ? `${authorName}` : '';
        nameNode.style.cursor = 'pointer';
        nameNode.addEventListener('click', (ev) => { ev.stopPropagation(); openProfileModalFor(currentAuthorId); });
        authorEl.appendChild(nameNode);

        const isNotice = data.notice === true || data.isNotice === true || data.isPinned === true;
        if (isNotice) {
          const tag = document.createElement('span');
          tag.className = 'role-tag';
          tag.style.marginLeft = '8px';
          tag.textContent = '공지';
          authorEl.appendChild(tag);
        }

        if (authorProfile) {
          authorAvatarEl.src = authorProfile;
        } else {
          authorAvatarEl.src = DEFAULT_AVATAR;
        }

        if (data.createdAt) {
          let date;
          if (typeof data.createdAt.toDate === 'function') {
            date = data.createdAt.toDate();
          } else {
            date = new Date(data.createdAt);
          }
          createdAtEl.innerText = date && !isNaN(date.getTime()) ? date.toLocaleString() : '';
        } else {
          createdAtEl.innerText = '';
        }

        const viewCountVal = (typeof data.viewCount === 'number') ? data.viewCount : 0;
        postViewCountEl.innerText = `조회수 ${viewCountVal}`;
        // ensure admin view-edit button exists and is placed
        ensureAdminViewEditBtn();

        /* -----------------------------
           변경된 부분: 게시물 내용 렌더링(HTML 허용, 안전하게 sanitize)
           - 여기만 수정했습니다. 다른 모든 코드는 원본 그대로 유지.
           ----------------------------- */
        try {
          // helper: decode &lt; &gt; entities
          function decodeHtmlEntities(str) {
            const t = document.createElement('textarea');
            t.innerHTML = str;
            return t.value;
          }
          // helper: 동적으로 DOMPurify 로드(없을 경우)
          async function ensureDOMPurify() {
            if (window.DOMPurify) return window.DOMPurify;
            return new Promise((resolve, reject) => {
              const s = document.createElement('script');
              s.src = 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js';
              s.onload = () => resolve(window.DOMPurify);
              s.onerror = () => reject(new Error('DOMPurify 로드 실패'));
              document.head.appendChild(s);
            });
          }
          // helper: sanitize + iframe whitelist 처리
          async function sanitizeHtml(html) {
            try {
              const DP = await ensureDOMPurify();
              // allow some media tags and style attribute for admin content
              const clean = DP.sanitize(html, {
                ADD_TAGS: ['iframe','video','source','track'],
                ADD_ATTR: ['allow','allowfullscreen','frameborder','scrolling','controls','playsinline','muted','poster','preload','style','loading']
              });
              // post-process: remove/replace unsafe iframes (허용된 호스트만)
              const tmp = document.createElement('div');
              tmp.innerHTML = clean;
              tmp.querySelectorAll('iframe').forEach(iframe => {
                const src = iframe.getAttribute('src') || '';
                const allowed = /^(https?:)?\/\/(www\.)?(youtube\.com|youtu\.be|player\.vimeo\.com)/i.test(src);
                if (!allowed) {
                  // 안전하게 iframe 제거하고 링크로 대체
                  const a = document.createElement('a');
                  a.href = src || '#';
                  a.textContent = src ? '외부 동영상 링크(열기)' : '외부 동영상';
                  a.target = '_blank';
                  iframe.parentNode.replaceChild(a, iframe);
                } else {
                  // lazy load & referrerpolicy for allowed iframes
                  iframe.setAttribute('loading', 'lazy');
                  iframe.setAttribute('referrerpolicy', 'no-referrer');
                }
              });
              return tmp.innerHTML;
            } catch (e) {
              console.error('sanitizeHtml error', e);
              return '';
            }
          }

          if (data.contentHtml) {
            const safe = await sanitizeHtml(data.contentHtml);
            if (safe) contentEl.innerHTML = safe;
            else contentEl.innerText = '(내용 없음)';
          } else if (data.content) {
            const raw = data.content;
            // 엔티티로 저장된 경우 디코드
            let candidate = raw;
            if (raw.includes('&lt;') && !raw.includes('<')) candidate = decodeHtmlEntities(raw);
            if (candidate.includes('<')) {
              const safe = await sanitizeHtml(candidate);
              if (safe) contentEl.innerHTML = safe;
              else contentEl.textContent = decodeHtmlEntities(raw) || raw;
            } else {
              contentEl.innerText = raw;
            }
          } else {
            contentEl.innerText = '(내용 없음)';
          }
        } catch (e) {
          console.error('content render failed', e);
          contentEl.innerText = data.content || '(내용 없음)';
        }

        galleryEl.innerHTML = '';
        if (data.imageUrls && Array.isArray(data.imageUrls) && data.imageUrls.length) {
          data.imageUrls.slice(0,6).forEach((u,i) => {
            const img = document.createElement('img');
            img.src = u;
            img.alt = `이미지 ${i+1}`;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '1px solid rgba(255,255,255,0.04)';
            img.loading = 'lazy';
            galleryEl.appendChild(img);
          });
        } else if (data.imageUrl) {
          const img = document.createElement('img');
          img.src = data.imageUrl;
          img.alt = '이미지';
          img.style.width = '100%';
          img.style.height = 'auto';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '1px solid rgba(255,255,255,0.04)';
          img.loading = 'lazy';
          galleryEl.appendChild(img);
        }

        const authorBlock = document.getElementById('authorBlock');
        if (authorBlock) {
          authorBlock.onclick = () => openProfileModalFor(currentAuthorId);
          authorBlock.onkeypress = (ev) => { if (ev.key === 'Enter') openProfileModalFor(currentAuthorId); };
        }

        setupPostLikesListener();
        setupPostBookmarksListener();
        setupCommentsListener();

        try {
          const viewedKey = `viewed_post_${currentPostId}`;
          if (!sessionStorage.getItem(viewedKey)) {
            try {
              await updateDoc(postDocRef, { viewCount: increment(1) });
              const newVal = viewCountVal + 1;
              postViewCountEl.innerText = `조회수 ${newVal}`;
            } catch (e) {
              console.error('viewCount update failed', e);
            }
            sessionStorage.setItem(viewedKey, '1');
          }
        } catch (e) {
          console.error(e);
        }

        toggleAdminControls(); // ensure admin controls reflect for new post
        return;
      } catch (err) {
        console.error(err);
        titleEl.innerText = '게시글을 불러오는 중 오류가 발생했습니다.';
        contentEl.innerText = '';
        postViewCountEl.innerText = '';
        document.title = "게시글 보기 - 유피드 밴블리온";
        throw err;
      }
    }

    // --- Post Likes ---
    function setupPostLikesListener() {
      const likesCol = collection(db, 'gaesi', currentPostId, 'likes');
      if (postLikeListenerUnsub) postLikeListenerUnsub();
      postLikeListenerUnsub = onSnapshot(likesCol, (snap) => {
        const likeCount = snap.size;
        postLikeCountEl.innerText = likeCount;
        if (currentUser) {
          const meLiked = snap.docs.some(d => d.id === currentUser.uid);
          postLikedByCurrentUser = meLiked;
          renderPostLikeButton();
        } else {
          postLikedByCurrentUser = false;
          renderPostLikeButton();
        }
      }, (err) => {
        console.error('post likes listener error', err);
      });
    }

    function renderPostLikeButton() {
      postLikeLabel.innerText = '좋아요';
      if (postLikedByCurrentUser) {
        postLikeBtn.style.color = '#ffae42';
      } else {
        postLikeBtn.style.color = '';
      }
    }

    postLikeBtn.addEventListener('click', async () => {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      const userLikeRef = doc(db, 'gaesi', currentPostId, 'likes', currentUser.uid);
      try {
        const existsSnap = await getDoc(userLikeRef);
        if (existsSnap.exists()) {
          await deleteDoc(userLikeRef);
        } else {
          await setDoc(userLikeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
        }
      } catch (e) {
        console.error(e);
      }
    });

    // --- Post Bookmarks ---
    function setupPostBookmarksListener() {
      const bookmarksCol = collection(db, 'gaesi', currentPostId, 'bookmarks');
      if (postBookmarkListenerUnsub) postBookmarkListenerUnsub();
      postBookmarkListenerUnsub = onSnapshot(bookmarksCol, (snap) => {
        const bookmarkCount = snap.size;
        postBookmarkCountEl.innerText = bookmarkCount;
        if (currentUser) {
          const meBookmarked = snap.docs.some(d => d.id === currentUser.uid);
          postBookmarkedByCurrentUser = meBookmarked;
          renderPostBookmarkButton();
        } else {
          postBookmarkedByCurrentUser = false;
          renderPostBookmarkButton();
        }
      }, (err) => {
        console.error('post bookmarks listener error', err);
      });
    }

    function renderPostBookmarkButton() {
      postBookmarkLabel.innerText = '북마크';
      if (postBookmarkedByCurrentUser) {
        postBookmarkBtn.style.color = '#ffae42';
      } else {
        postBookmarkBtn.style.color = '';
      }
    }

    postBookmarkBtn.addEventListener('click', async () => {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      const userBookmarkRef = doc(db, 'gaesi', currentPostId, 'bookmarks', currentUser.uid);
      try {
        const existsSnap = await getDoc(userBookmarkRef);
        if (existsSnap.exists()) {
          await deleteDoc(userBookmarkRef);
        } else {
          await setDoc(userBookmarkRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
        }
      } catch (e) {
        console.error(e);
      }
    });

    // --- Comments: add + real-time render + comment likes + admin pin support ---
    function setupCommentsListener() {
      const commentsCol = collection(db, 'gaesi', currentPostId, 'comments');
      const q = query(commentsCol, orderBy('createdAt', 'desc'));
      if (commentsListenerUnsub) commentsListenerUnsub();
      commentsListenerUnsub = onSnapshot(q, (snapshot) => {
        const docs = [];
        snapshot.forEach(d => docs.push({ id: d.id, data: d.data() }));
        // Separate pinned and others, sort pinned by pinnedAt desc, others by createdAt desc
        const pinned = docs.filter(x => x.data.pinned).sort((a,b) => {
          const aa = a.data.pinnedAt && typeof a.data.pinnedAt.toDate === 'function' ? a.data.pinnedAt.toDate().getTime() : (a.data.pinnedAt ? new Date(a.data.pinnedAt).getTime() : 0);
          const bb = b.data.pinnedAt && typeof b.data.pinnedAt.toDate === 'function' ? b.data.pinnedAt.toDate().getTime() : (b.data.pinnedAt ? new Date(b.data.pinnedAt).getTime() : 0);
          return bb - aa;
        });
        const rest = docs.filter(x => !x.data.pinned).sort((a,b) => {
          const aa = a.data.createdAt && typeof a.data.createdAt.toDate === 'function' ? a.data.createdAt.toDate().getTime() : (a.data.createdAt ? new Date(a.data.createdAt).getTime() : 0);
          const bb = b.data.createdAt && typeof b.data.createdAt.toDate === 'function' ? b.data.createdAt.toDate().getTime() : (b.data.createdAt ? new Date(b.data.createdAt).getTime() : 0);
          return bb - aa;
        });
        commentsList.innerHTML = '';
        const ordered = [...pinned, ...rest];
        commentsCountEl.innerText = `${docs.length}`;
        ordered.forEach(({id, data}) => {
          const item = renderCommentItem(id, data);
          commentsList.appendChild(item);
        });
      }, (err) => {
        console.error('comments listener error', err);
      });
    }

    function renderCommentItem(commentId, commentData) {
      const div = document.createElement('div');
      div.className = 'comment-item';
      const avatar = document.createElement('img');
      avatar.className = 'comment-author-avatar';
      const avatarUrl = commentData.authorProfileUrl || DEFAULT_AVATAR;
      avatar.src = avatarUrl;
      avatar.alt = '프로필';
      avatar.style.cursor = 'pointer';
      avatar.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const targetUserId = commentData.authorId || null;
        if (targetUserId) openProfileModalFor(targetUserId);
        else alert('프로필 정보를 불러올 수 없습니다.');
      });

      const body = document.createElement('div');
      body.className = 'comment-body';

      const head = document.createElement('div');
      head.className = 'comment-head';
      const name = document.createElement('div');
      name.className = 'comment-author-name';
      name.innerText = commentData.authorName || '익명';
      name.style.cursor = 'pointer';
      name.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const targetUserId = commentData.authorId || null;
        if (targetUserId) openProfileModalFor(targetUserId);
        else alert('프로필 정보를 불러올 수 없습니다.');
      });

      const date = document.createElement('div');
      date.className = 'comment-date';
      if (commentData.createdAt) {
        let d;
        if (typeof commentData.createdAt.toDate === 'function') d = commentData.createdAt.toDate();
        else d = new Date(commentData.createdAt);
        date.innerText = d && !isNaN(d.getTime()) ? d.toLocaleString() : '';
      } else date.innerText = '';

      if (commentData.pinned) {
        const pinnedTag = document.createElement('span');
        pinnedTag.className = 'pinned-tag';
        pinnedTag.textContent = '고정';
        head.appendChild(pinnedTag);
      }

      head.appendChild(name);
      head.appendChild(date);

      const content = document.createElement('div');
      content.className = 'comment-content';
      content.innerText = commentData.content || '';

      const actions = document.createElement('div');
      actions.className = 'comment-actions';

      const likeBtn = document.createElement('button');
      likeBtn.className = 'like-btn';
      likeBtn.innerHTML = `♡ <span class="c-like-count">${commentData.likeCount || 0}</span>`;
      likeBtn.title = '공감';

      async function refreshCommentLikeState() {
        if (!currentUser) {
          likeBtn.classList.remove('liked');
          return;
        }
        try {
          const likeDoc = await getDoc(doc(db, 'gaesi', currentPostId, 'comments', commentId, 'likes', currentUser.uid));
          if (likeDoc.exists()) likeBtn.classList.add('liked');
          else likeBtn.classList.remove('liked');
        } catch (e) {
        }
      }
      refreshCommentLikeState();

      likeBtn.addEventListener('click', async () => {
        if (!currentUser) { openModal('loginModal'); return; }
        const likeRef = doc(db, 'gaesi', currentPostId, 'comments', commentId, 'likes', currentUser.uid);
        const commentDocRef = doc(db, 'gaesi', currentPostId, 'comments', commentId);
        try {
          const existing = await getDoc(likeRef);
          if (existing.exists()) {
            await deleteDoc(likeRef);
            try { await updateDoc(commentDocRef, { likeCount: increment(-1) }); } catch (_) {}
            const countSpan = likeBtn.querySelector('.c-like-count');
            if (countSpan) countSpan.innerText = Math.max(0, (commentData.likeCount || 0) - 1);
            likeBtn.classList.remove('liked');
          } else {
            await setDoc(likeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
            try { await updateDoc(commentDocRef, { likeCount: increment(1) }); } catch (_) {}
            const countSpan = likeBtn.querySelector('.c-like-count');
            if (countSpan) countSpan.innerText = (commentData.likeCount || 0) + 1;
            likeBtn.classList.add('liked');
          }
        } catch (e) {
          console.error(e);
        }
      });

      actions.appendChild(likeBtn);

      if (isAdmin) {
        const adminEditCommentLikesBtn = document.createElement('button');
        adminEditCommentLikesBtn.className = 'admin-edit-btn';
        adminEditCommentLikesBtn.textContent = '좋아요 편집';
        adminEditCommentLikesBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          const inp = prompt('댓글 좋아요 수를 입력하세요 (숫자):', String(commentData.likeCount || 0));
          if (inp === null) return;
          const n = parseInt(inp);
          if (isNaN(n) || n < 0) { alert('유효한 숫자를 입력하세요'); return; }
          await adminSetCommentLikes(commentId, n);
        });
        actions.appendChild(adminEditCommentLikesBtn);

        const pinBtn = document.createElement('button');
        pinBtn.className = 'admin-edit-btn';
        pinBtn.textContent = commentData.pinned ? '고정 해제' : '고정';
        pinBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          try {
            const commentDocRef = doc(db, 'gaesi', currentPostId, 'comments', commentId);
            if (commentData.pinned) {
              await updateDoc(commentDocRef, { pinned: false });
            } else {
              await updateDoc(commentDocRef, { pinned: true, pinnedAt: serverTimestamp() });
            }
          } catch (e) {
            console.error(e);
            alert('고정 작업 중 오류가 발생했습니다.');
          }
        });
        actions.appendChild(pinBtn);
      }

      body.appendChild(head);
      body.appendChild(content);
      body.appendChild(actions);

      div.appendChild(avatar);
      div.appendChild(body);

      return div;
    }

    // submit comment
    commentSubmit.addEventListener('click', async () => {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      const text = commentInput.value && commentInput.value.trim();
      if (!text) {
        alert('댓글을 입력하세요.');
        return;
      }
      try {
        let authorName = currentUser.displayName || currentUser.email || '사용자';
        let authorProfile = currentUser.photoURL || '';

        try {
          const uDoc = await getDoc(doc(db, 'users', currentUser.uid));
          if (uDoc.exists()) {
            const ud = uDoc.data();
            authorName = ud.displayName || authorName;
            authorProfile = ud.photoURL || authorProfile;
          }
        } catch (e) { /* ignore */ }

        const commentsCol = collection(db, 'gaesi', currentPostId, 'comments');
        await addDoc(commentsCol, {
          authorId: currentUser.uid,
          authorName,
          authorProfileUrl: authorProfile || '',
          content: text,
          createdAt: serverTimestamp(),
          likeCount: 0,
          pinned: false
        });
        commentInput.value = '';
      } catch (e) {
        console.error(e);
        alert('댓글 작성 중 오류가 발생했습니다.');
      }
    });

    // --- Profile modal functionality (users 컬렉션 기반) ---
    const profileModal = document.getElementById('profileModal');
    const profileBanner = document.getElementById('profileBanner');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileNickname = document.getElementById('profileNickname');
    const profileBio = document.getElementById('profileBio');
    const followersCountEl = document.getElementById('followersCount');
    const followingCountEl = document.getElementById('followingCount');
    const followBtn = document.getElementById('followBtn');

    async function openProfileModalFor(userId) {
      if (!userId) {
        alert('해당 사용자의 프로필을 불러올 수 없습니다.');
        return;
      }
      try {
        await loadProfileIntoModal(userId);
        openModal('profileModal');
      } catch (e) {
        console.error(e);
        alert('프로필을 불러오는 중 오류가 발생했습니다.');
      }
    }

    async function loadProfileIntoModal(userId) {
      // NEW: set modal target uid so admin edits apply to modal target (not post author)
      profileModalUserId = userId;

      profileBanner.src = DEFAULT_BANNER;
      profileAvatar.src = DEFAULT_AVATAR;
      profileNickname.textContent = '사용자';
      profileBio.textContent = '';
      // 초기값 설정: span이 있으면 span을 업데이트, 없으면 fallback
      if (followersCountValueEl) followersCountValueEl.innerText = '0';
      else if (followersCountEl) followersCountEl.textContent = '팔로워 0';
      if (followingCountValueEl) followingCountValueEl.innerText = '0';
      else if (followingCountEl) followingCountEl.textContent = '팔로잉 0';

      followBtn.style.display = 'none';
      followBtn.textContent = '팔로우';

      const userRef = doc(db, 'users', userId);
      const uSnap = await getDoc(userRef);
      if (!uSnap.exists()) {
        profileNickname.textContent = '사용자';
        profileBio.textContent = '(정보 없음)';
        return;
      }
      const udata = uSnap.data();

      const bannerUrl = udata.bannerUrl || udata.coverPhoto || '';
      const avatarUrl = udata.photoURL || udata.avatarUrl || '';
      profileBanner.src = bannerUrl || DEFAULT_BANNER;
      profileAvatar.src = avatarUrl || DEFAULT_AVATAR;

      profileNickname.textContent = udata.displayName || udata.nickname || udata.email || '사용자';
      profileBio.textContent = udata.bio || udata.description || '';

      const role = udata.role || '';
      const existingRoleTag = profileNickname.querySelector('.profile-role');
      if (existingRoleTag) existingRoleTag.remove();
      if (role && role.toLowerCase() === 'admin') {
        const span = document.createElement('span');
        span.className = 'profile-role';
        span.textContent = '운영자';
        profileNickname.appendChild(span);
      }

      let followerCount = (typeof udata.followerCount === 'number') ? udata.followerCount : null;
      let followingCount = (typeof udata.followingCount === 'number') ? udata.followingCount : null;

      if (followerCount === null) {
        try {
          const docs = await getDocs(collection(db, 'users', userId, 'followers'));
          followerCount = docs.size;
        } catch (e) {
          followerCount = 0;
        }
      }
      if (followingCount === null) {
        try {
          const docs2 = await getDocs(collection(db, 'users', userId, 'following'));
          followingCount = docs2.size;
        } catch (e) {
          followingCount = 0;
        }
      }
      // 여기서도 전체 element.textContent로 덮어쓰지 않고 값(span)을 업데이트
      if (followersCountValueEl) followersCountValueEl.innerText = String(followerCount || 0);
      else if (followersCountEl) followersCountEl.textContent = `팔로워 ${followerCount}`;
      if (followingCountValueEl) followingCountValueEl.innerText = String(followingCount || 0);
      else if (followingCountEl) followingCountEl.textContent = `팔로잉 ${followingCount}`;

      if (!currentUser || currentUser.uid === userId) {
        followBtn.style.display = 'none';
      } else {
        followBtn.style.display = 'inline-block';
        try {
          const relDoc = await getDoc(doc(db, 'users', currentUser.uid, 'following', userId));
          if (relDoc.exists()) {
            followBtn.textContent = '언팔로우';
            followBtn.dataset.following = '1';
          } else {
            followBtn.textContent = '팔로우';
            followBtn.dataset.following = '0';
          }
        } catch (e) {
          followBtn.textContent = '팔로우';
          followBtn.dataset.following = '0';
        }
      }

      followBtn.onclick = async (ev) => {
        ev.stopPropagation();
        if (!currentUser) {
          openModal('loginModal');
          return;
        }
        try {
          const amFollowing = followBtn.dataset.following === '1';
          const followingRef = doc(db, 'users', currentUser.uid, 'following', userId);
          const followerRef = doc(db, 'users', userId, 'followers', currentUser.uid);
          const userDocRef = doc(db, 'users', userId);
          const myDocRef = doc(db, 'users', currentUser.uid);

          if (amFollowing) {
            await deleteDoc(followingRef);
            await deleteDoc(followerRef);
            try { await updateDoc(userDocRef, { followerCount: increment(-1) }); } catch (_) {}
            try { await updateDoc(myDocRef, { followingCount: increment(-1) }); } catch (_) {}
            followBtn.textContent = '팔로우';
            followBtn.dataset.following = '0';
            const currentFollowers = parseInt((followersCountValueEl ? followersCountValueEl.innerText : (followersCountEl ? followersCountEl.textContent : '')).replace(/[^0-9]/g,'')) || 0;
            if (followersCountValueEl) followersCountValueEl.innerText = String(Math.max(0, currentFollowers - 1));
            else if (followersCountEl) followersCountEl.textContent = `팔로워 ${Math.max(0, currentFollowers - 1)}`;
          } else {
            await setDoc(followingRef, { uid: userId, createdAt: serverTimestamp() });
            await setDoc(followerRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
            try { await updateDoc(userDocRef, { followerCount: increment(1) }); } catch (_) {}
            try { await updateDoc(myDocRef, { followingCount: increment(1) }); } catch (_) {}
            followBtn.textContent = '언팔로우';
            followBtn.dataset.following = '1';
            const currentFollowers = parseInt((followersCountValueEl ? followersCountValueEl.innerText : (followersCountEl ? followersCountEl.textContent : '')).replace(/[^0-9]/g,'')) || 0;
            if (followersCountValueEl) followersCountValueEl.innerText = String(currentFollowers + 1);
            else if (followersCountEl) followingCountEl.textContent = `팔로워 ${currentFollowers + 1}`;
          }
        } catch (e) {
          console.error(e);
          alert('팔로우 작업 중 오류가 발생했습니다.');
        }
      };

      toggleAdminControls(); // ensure edit buttons on profile reflect admin state
    }

    // init (처음 로드 시 현재 ID로 게시글을 불러옴)
    initPost();

    // 모달 간 전환 버튼
    document.getElementById('openSignupFromLogin').addEventListener('click', () => {
      closeModal('loginModal');
      openModal('signupModal');
    });
    document.getElementById('openLoginFromSignup').addEventListener('click', () => {
      closeModal('signupModal');
      openModal('loginModal');
    });

    // --- post options menu behavior (copy link) ---
    postOptionsBtn.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const isOpen = postOptionsMenu.style.display === 'block';
      if (isOpen) {
        postOptionsMenu.style.display = 'none';
        postOptionsBtn.setAttribute('aria-expanded','false');
      } else {
        postOptionsMenu.style.display = 'block';
        postOptionsBtn.setAttribute('aria-expanded','true');
      }
    });

    document.addEventListener('click', () => {
      postOptionsMenu.style.display = 'none';
      postOptionsBtn.setAttribute('aria-expanded','false');
    });

    copyLinkBtn.addEventListener('click', async () => {
      try {
        const url = window.location.href;
        await navigator.clipboard.writeText(url);
        alert('링크를 복사했습니다.');
      } catch (e) {
        alert('복사에 실패했습니다.');
      }
    });

    // --- Admin helper functions (댓글 좋아요/게시글 조회수/팔로우 수 편집) ---
    async function adminSetCommentLikes(commentId, n) {
      try {
        const commentDocRef = doc(db, 'gaesi', currentPostId, 'comments', commentId);
        await updateDoc(commentDocRef, { likeCount: n });
      } catch (e) {
        console.error(e);
        alert('수정 중 오류가 발생했습니다.');
      }
    }

    async function adminSetPostViews(n) {
      try {
        const postRef = doc(db, 'gaesi', currentPostId);
        await updateDoc(postRef, { viewCount: n });
        postViewCountEl.innerText = `조회수 ${n}`;
      } catch (e) {
        console.error(e);
        alert('조회수 수정 중 오류가 발생했습니다.');
      }
    }

    async function adminSetProfileFollowers(userId, n) {
      try {
        const userRef = doc(db, 'users', userId);
        await updateDoc(userRef, { followerCount: n });
      } catch (e) {
        console.error(e);
        alert('팔로워 수 수정 실패');
      }
    }

    async function adminSetProfileFollowing(userId, n) {
      try {
        const userRef = doc(db, 'users', userId);
        await updateDoc(userRef, { followingCount: n });
      } catch (e) {
        console.error(e);
        alert('팔로잉 수 수정 실패');
      }
    }

    // toggle admin UI elements
    function toggleAdminControls() {
      // show/hide admin small edit buttons depending on isAdmin
      const show = !!isAdmin;
      if (adminEditLikesBtn) adminEditLikesBtn.style.display = show ? 'inline-block' : 'none';
      if (adminEditBookmarksBtn) adminEditBookmarksBtn.style.display = show ? 'inline-block' : 'none';
      if (adminEditFollowersBtn) adminEditFollowersBtn.style.display = show ? 'inline-block' : 'none';
      if (adminEditFollowingBtn) adminEditFollowingBtn.style.display = show ? 'inline-block' : 'none';
      const av = ensureAdminViewEditBtn();
      if (av) av.style.display = show ? 'inline-block' : 'none';

      // profile modal edit btns: attach handlers (only once)
      if (adminEditFollowersBtn && !adminEditFollowersBtn._bound) {
        adminEditFollowersBtn._bound = true;
        adminEditFollowersBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          if (!isAdmin) return;
          const cur = parseInt((followersCountValueEl ? followersCountValueEl.innerText : '0').replace(/[^0-9]/g,'')) || 0;
          const inp = prompt('팔로워 수를 입력하세요 (숫자):', String(cur));
          if (inp === null) return;
          const n = parseInt(inp);
          if (isNaN(n) || n < 0) { alert('유효한 숫자를 입력하세요'); return; }
          if (!profileModalUserId) { alert('모달 대상 사용자가 설정되어 있지 않습니다.'); return; }
          await adminSetProfileFollowers(profileModalUserId, n);
          if (followersCountValueEl) followersCountValueEl.innerText = String(n);
        });
      }
      if (adminEditFollowingBtn && !adminEditFollowingBtn._bound) {
        adminEditFollowingBtn._bound = true;
        adminEditFollowingBtn.addEventListener('click', async (ev) => {
          ev.stopPropagation();
          if (!isAdmin) return;
          const cur = parseInt((followingCountValueEl ? followingCountValueEl.innerText : '0').replace(/[^0-9]/g,'')) || 0;
          const inp = prompt('팔로잉 수를 입력하세요 (숫자):', String(cur));
          if (inp === null) return;
          const n = parseInt(inp);
          if (isNaN(n) || n < 0) { alert('유효한 숫자를 입력하세요'); return; }
          if (!profileModalUserId) { alert('모달 대상 사용자가 설정되어 있지 않습니다.'); return; }
          await adminSetProfileFollowing(profileModalUserId, n);
          if (followingCountValueEl) followingCountValueEl.innerText = String(n);
        });
      }
    }

    // expose admin functions globally for debugging if needed
    window.__admin = {
      setPostViews: adminSetPostViews,
      setCommentLikes: adminSetCommentLikes,
      setProfileFollowers: adminSetProfileFollowers,
      setProfileFollowing: adminSetProfileFollowing
    };

  </script>
</body>
</html>



