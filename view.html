<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê²Œì‹œê¸€ ë³´ê¸° - ìœ í”¼ë“œ ë°´ë¸”ë¦¬ì˜¨</title>
  <style>
    /* --- (ì›ë³¸ CSSë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€, ì‚¬ì´íŠ¸ ìŠ¤íƒ€ì¼ 100% ì¼ì¹˜) --- */
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; padding: 0; background-color: #1c1c1c; color: #fff; font-family: Arial, sans-serif; -webkit-font-smoothing:antialiased; }

    .site-content {
      width: 100%;
      max-width: 970px;
      margin: 0 auto;
      padding: 0 12px;
    }

    header {
      background-color: #003d80;
      color: white;
      padding: 11px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .logo { font-size: 19.8px; font-weight: bold; }
    header .auth-buttons a { color: white; text-decoration: none; margin-left: 15px; font-weight: bold; font-size: 15.4px; transition: color .3s; cursor:pointer; }
    header .auth-buttons a:hover { color: #ffcc00; }

    /* ê²Œì‹œê¸€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
    .post-wrap {
      margin: 30px auto;
      background-color: #242424;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.45);
      padding: 22px;
    }
    .post-meta { color:#ccc; font-size:13px; margin-bottom:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .author-block { display:flex; gap:12px; align-items:center; cursor:pointer; }
    .author-avatar { width:48px; height:48px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,0.06); background:#111; flex:0 0 auto; }
    .post-title { font-size:22px; color:#ffea8a; margin:8px 0 8px 0; word-break:break-word; }
    .post-author { color:#ddd; font-weight:700; display:inline-flex; gap:8px; align-items:center; }
    .role-tag { background:#ffcc00; color:#000; padding:3px 8px; border-radius:8px; font-weight:700; font-size:12px; }
    .post-date { color:#bbb; font-size:13px; }
    .post-content { color:#eaeaea; margin-top:16px; line-height:1.7; white-space:pre-wrap; word-break:break-word; }
    .post-actions { margin-top:18px; display:flex; gap:10px; align-items:center; }
    .btn { padding:8px 12px; border-radius:8px; background:transparent; color:#ddd; border:1px solid rgba(255,255,255,0.06); cursor:pointer; font-weight:700; }
    .btn.primary { background: linear-gradient(90deg,#0f61b0,#0a3e7a); color:#fff; border:1px solid rgba(255,255,255,0.03); }

    /* ëŒ“ê¸€ ì˜ì—­ */
    .comments-wrap { margin-top:22px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
    .comment-form { display:flex; gap:10px; align-items:flex-start; margin-bottom:12px; }
    .comment-input { flex:1; min-height:48px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.35); color:#fff; resize:vertical; }
    .comment-submit { padding:8px 12px; border-radius:8px; background:#0f61b0; color:#fff; border:0; cursor:pointer; font-weight:700; }

    .comment-item { display:flex; gap:10px; padding:10px 6px; border-bottom:1px solid rgba(255,255,255,0.02); align-items:flex-start; }
    .comment-author-avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid rgba(255,255,255,0.04); background:#111; flex:0 0 auto; }
    .comment-body { flex:1; }
    .comment-head { display:flex; gap:8px; align-items:center; margin-bottom:6px; }
    .comment-author-name { font-weight:700; color:#fff; font-size:14px; }
    .comment-date { color:#bbb; font-size:12px; margin-left:6px; }
    .comment-content { color:#e6e6e6; font-size:14px; line-height:1.5; white-space:pre-wrap; word-break:break-word; }
    .comment-actions { margin-top:8px; display:flex; gap:10px; align-items:center; }
    .like-btn { background:transparent; border:0; color:#ddd; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:8px; }
    .like-btn.liked { color:#ffae42; }

    /* ê´€ë¦¬ì ì œì–´ë°” (ì‘ê²Œ ì¶”ê°€) */
    .admin-control { margin: 14px auto; max-width: 970px; padding: 8px 12px; display:flex; gap:8px; align-items:center; color:#ddd; }
    .admin-control input { background:#1b1b1b; border:1px solid rgba(255,255,255,0.05); color:#fff; padding:8px; border-radius:8px; flex:1; }
    .admin-control button { padding:8px 10px; border-radius:8px; background:#0f61b0; color:#fff; border:0; cursor:pointer; font-weight:700; }

    /* ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬, pw-toggle ë“± ì›ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; padding:20px; box-sizing:border-box; }
    .modal-content { width:420px; max-width: calc(100% - 40px); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; color:white; box-shadow:0 10px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03); backdrop-filter: blur(6px) saturate(120%); display:flex; flex-direction:column; gap:12px; }
    .modal-close { position: absolute; top: 10px; right: 10px; background: transparent; color: #ddd; border: none; cursor: pointer; font-size: 20px; padding: 6px; border-radius: 8px; transition: background .15s, color .15s; z-index: 1010; }
    .modal-close:hover { background: rgba(255,255,255,0.02); color:#fff; }
    .modal-inner { display:flex; gap:12px; align-items:center; }
    .modal-brand img { width:56px; height:56px; border-radius:8px; flex:0 0 auto; }

    .field { display:block; margin-top:8px; width:100%; }
    input[type="email"], input[type="password"], input[type="text"] { width:100%; margin:8px 0 0 0; padding:12px 44px 12px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.4); color:#fff; outline:none; font-size:14px; box-sizing:border-box; }

    .password-field { position: relative; }
    .password-field .pw-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #ddd;
      padding: 6px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .pw-toggle svg { width:18px; height:18px; display:block; }
    .pw-toggle .icon-eye-off { display: none; }

    .modal-actions { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:8px; }
    .alt-btn { flex:1; padding:8px 10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:#ddd; border-radius:8px; font-size:13px; cursor:pointer; }
    .primary-btn { width:100%; background: linear-gradient(90deg,#0f61b0,#0a3e7a); color:#fff; box-shadow:0 6px 18px rgba(15,97,176,0.16); border:1px solid rgba(255,255,255,0.03); padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:bold; }

    /* Profile modal specific */
    .profile-modal .modal-content { width:720px; max-width: calc(100% - 40px); padding:0; overflow:hidden; }
    .profile-top { position:relative; height:160px; background:#111; display:flex; align-items:flex-end; }
    .profile-banner { width:100%; height:100%; object-fit:cover; display:block; }
    .profile-top-inner { position:absolute; left:18px; bottom:-34px; display:flex; gap:16px; align-items:center; }
    .profile-top-inner .profile-avatar { width:68px; height:68px; border-radius:50%; border:3px solid #111; object-fit:cover; background:#222; }
    .profile-top-inner .profile-meta { color:#fff; }
    .profile-nick { font-size:20px; font-weight:800; display:flex; gap:8px; align-items:center; }
    .profile-role { background:#ffcc00; color:#000; padding:4px 8px; border-radius:8px; font-weight:700; font-size:12px; }
    .profile-bio { font-size:13px; color:#ddd; margin-top:6px; max-width:520px; }

    .profile-body { padding:54px 18px 18px 18px; display:flex; flex-direction:column; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); }
    .profile-stats { display:flex; gap:12px; align-items:center; }
    .profile-stats .stat { font-weight:700; color:#fff; }
    .profile-actions { margin-left:auto; }
    .follow-btn { padding:8px 12px; border-radius:8px; background:#0f61b0; color:#fff; border:0; cursor:pointer; font-weight:800; }

    .activity-note { text-align:center; color:#bbb; font-size:13px; padding:14px 0; border-top:1px dashed rgba(255,255,255,0.03); }

    footer { background:#111; color:#ccc; font-size:12px; padding:20px; text-align:center; line-height:1.5; margin-top:40px; }
    footer a { color:#ccc; text-decoration:none; margin:0 4.5px; }
    @media (max-width:600px) {
      .post-title { font-size:18px; }
      .post-wrap { padding:16px; margin:18px 12px; }
      .author-avatar { width:40px; height:40px; }
      .admin-control { padding:8px; gap:6px; }
      .profile-modal .modal-content { width:calc(100% - 20px); }
    }
  </style>
</head>
<body>

  <!-- === header (ì›ë³¸ê³¼ ë™ì¼) === -->
  <header>
    <a href="index.html" class="logo" aria-label="í™ˆìœ¼ë¡œ ì´ë™" style="color:inherit; text-decoration:none;">BANBLE LEON</a>
    <div class="auth-buttons">
      <a onclick="openModal('loginModal')">ë¡œê·¸ì¸</a>
      <a onclick="openModal('signupModal')">íšŒì›ê°€ì…</a>
      <a id="logoutBtn" style="display:none;cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</a>
      <span id="userName" style="margin-left:15px; font-weight:bold; color:#ffcc00; display:none;"></span>
    </div>
  </header>

  <!-- === ê´€ë¦¬ì ì œì–´ë°”: ì–´ë–¤ ê²Œì‹œê¸€ì„ ë·°ì–´ë§í• ì§€ ì„¤ì • (ì¶”ê°€) === -->
  <div class="admin-control" role="region" aria-label="ê´€ë¦¬ì ê²Œì‹œê¸€ ì„ íƒ">
    <input id="adminPostIdInput" type="text" placeholder="ë·°ì–´ì— í‘œì‹œí•  gaesi ë¬¸ì„œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: osQ0GPHi5GRRFOIRNpW0)">
    <button id="adminSetBtn">ì„¤ì •</button>
    <button id="adminClearBtn" style="background:#444;color:#fff;border-radius:8px;padding:8px 10px;border:0;cursor:pointer;font-weight:700;">ì´ˆê¸°í™”</button>
  </div>

  <!-- === main content: ê²Œì‹œê¸€ ë·°ì–´ë§Œ ë‚¨ê¹€ === -->
  <div class="site-content">
    <div class="post-wrap" id="postWrap" aria-live="polite">

      <!-- ì‘ì„±ì í”„ë¡œí•„/ì´ë¦„/ë‚ ì§œ (ìš”ì²­: ì œëª© ìœ„ë¡œ) -->
      <div class="post-meta" style="margin-bottom:6px;">
        <div class="author-block" style="flex:1;" id="authorBlock" role="button" tabindex="0" aria-label="ì‘ì„±ì í”„ë¡œí•„ ë³´ê¸°">
          <img id="authorAvatar" class="author-avatar" src="https://via.placeholder.com/48?text=?" alt="ì‘ì„±ì í”„ë¡œí•„">
          <div>
            <div id="author" class="post-author"></div>
            <div style="display:flex; gap:8px; align-items:center;">
              <div id="createdAt" class="post-date"></div>
              <div id="postViewCount" class="post-date" style="margin-left:8px;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ì œëª© (ì•„ë˜ë¡œ ì´ë™) -->
      <h1 class="post-title" id="title">ë¡œë”© ì¤‘...</h1>

      <div class="post-content" id="content">ê²Œì‹œê¸€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤.</div>

      <!-- ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ (ì´ë¯¸ì§€ë¥¼ ê°€ë¡œí­ì— ë§ê²Œ í¬ê²Œ í‘œì‹œ) -->
      <div id="imageGallery" style="margin-top:16px; display:flex; gap:8px; flex-direction:column;"></div>

      <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ë° ë¶ë§ˆí¬ ë²„íŠ¼ (ìš”ì²­: ë‚´ìš©/ì´ë¯¸ì§€ ì•„ë˜ë¡œ ì´ë™) -->
      <div style="margin-top:16px; display:flex; gap:10px; align-items:center;">
        <button id="postLikeBtn" class="btn" title="ì¢‹ì•„ìš”"><span id="postLikeLabel">â™¡ ì¢‹ì•„ìš”</span> <span id="postLikeCount" style="margin-left:8px;color:#ffae42;">0</span></button>
        <button id="postBookmarkBtn" class="btn" title="ë¶ë§ˆí¬"><span id="postBookmarkLabel">ğŸ”– ë¶ë§ˆí¬</span> <span id="postBookmarkCount" style="margin-left:8px;color:#ffae42;">0</span></button>
        <!-- ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ì€ ìš”ì²­ì— ë”°ë¼ ì œê±° -->
      </div>

      <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
      <div class="comments-wrap" id="commentsWrap" aria-live="polite">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:800; color:#ffae42;">ëŒ“ê¸€</div>
          <div id="commentsCount" style="color:#bbb;">0</div>
        </div>

        <div id="commentFormArea" style="margin-bottom:12px;">
          <div class="comment-form">
            <textarea id="commentInput" class="comment-input" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ í›„ ì…ë ¥í•˜ì„¸ìš”." rows="2" disabled></textarea>
            <button id="commentSubmit" class="comment-submit">ë“±ë¡</button>
          </div>
        </div>

        <div id="commentsList"></div>
      </div>

      <div class="post-actions" id="postActions" style="display:none;">
        <!-- ì¶”ê°€ ì•¡ì…˜ ë²„íŠ¼ë“¤(ë¡œê·¸ì¸í•œ ì‘ì„±ìì—ê²Œ ë…¸ì¶œ ë“±)ì€ ì—¬ê¸° ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ -->
      </div>
    </div>
  </div>

  <!-- === ë¡œê·¸ì¸ ëª¨ë‹¬ (ì›ë³¸ê³¼ ë™ì¼) === -->
  <div id="loginModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="loginTitle">
    <div class="modal-content" role="document">
      <button class="modal-close" onclick="closeModal('loginModal')" aria-label="ë‹«ê¸°">&times;</button>
      <div class="modal-inner">
        <div class="modal-brand">
          <img src="https://i.imgur.com/FzKC3OX.png" alt="ë¸Œëœë“œ" style="width:56px;height:56px;border-radius:8px;">
          <div>
            <h2 id="loginTitle">ë¡œê·¸ì¸</h2>
            <p>ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ ìœ í”¼ë“œ í™€ì„ ì´ìš©í•˜ì„¸ìš”.</p>
          </div>
        </div>
      </div>

      <div>
        <label class="field">
          <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" />
        </label>

        <label class="field password-field">
          <input type="password" id="loginPass" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <button type="button" class="pw-toggle" data-target="loginPass" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°" title="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°">
            <svg class="icon-eye" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M1.5 12C1.5 12 5.5 4 12 4s10.5 8 10.5 8-4 8-10.5 8S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17.94 17.94C16.31 19.05 14.24 19.74 12 19.74 6.5 19.74 2 12 2 12s2.41-3.32 6.07-5.24" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9.88 9.88A3 3 0 0114.12 14.12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </label>

        <div class="modal-actions">
          <label style="font-size:13px;color:#ccc;"><input type="checkbox" id="rememberMe" style="margin-right:6px;"/> ë¡œê·¸ì¸ ìœ ì§€</label>
        </div>

        <button id="loginSubmit" class="primary-btn">ë¡œê·¸ì¸</button>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="openSignupFromLogin" class="alt-btn" type="button">ê³„ì • ë§Œë“¤ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === íšŒì›ê°€ì… ëª¨ë‹¬ (ì›ë³¸ê³¼ ë™ì¼) === -->
  <div id="signupModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="signupTitle">
    <div class="modal-content" role="document">
      <button class="modal-close" onclick="closeModal('signupModal')" aria-label="ë‹«ê¸°">&times;</button>
      <div class="modal-inner">
        <div class="modal-brand">
          <img src="https://i.imgur.com/5fdGvm7.png" alt="íšŒì›ê°€ì…" style="width:56px;height:56px;border-radius:8px;">
          <div>
            <h2 id="signupTitle">ìœ í”¼ë“œ ê³„ì • ìƒì„±</h2>
            <p>ë°´ë¸”ë¦¬ì˜¨ì˜ ìœ í”¼ë“œ ì„œë¹„ìŠ¤ì— ê°€ì…í•˜ì„¸ìš”</p>
          </div>
        </div>
      </div>

      <div>
        <label class="field">
          <input type="text" id="signupNickname" placeholder="ë‹‰ë„¤ì„" />
        </label>
        <label class="field">
          <input type="email" id="signupEmail" placeholder="ì´ë©”ì¼" />
        </label>
        <label class="field password-field">
          <input type="password" id="signupPass" placeholder="ë¹„ë°€ë²ˆí˜¸" />
          <button type="button" class="pw-toggle" data-target="signupPass" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°" title="ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°">
            <svg class="icon-eye" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M1.5 12C1.5 12 5.5 4 12 4s10.5 8 10.5 8-4 8-10.5 8S1.5 12 1.5 12Z" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <svg class="icon-eye-off" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
              <path d="M3 3l18 18" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M17.94 17.94C16.31 19.05 14.24 19.74 12 19.74 6.5 19.74 2 12 2 12s2.41-3.32 6.07-5.24" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M9.88 9.88A3 3 0 0114.12 14.12" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </label>

        <button id="signupSubmit" class="primary-btn">íšŒì›ê°€ì…</button>

        <div style="display:flex;gap:8px;margin-top:8px;">
          <button id="openLoginFromSignup" class="alt-btn" type="button">ë¡œê·¸ì¸ í•˜ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- === Profile Modal (ìƒˆë¡œ ì¶”ê°€) === -->
  <div id="profileModal" class="modal profile-modal" aria-hidden="true" role="dialog" aria-labelledby="profileTitle">
    <div class="modal-content" role="document" style="position:relative;">
      <button class="modal-close" onclick="closeModal('profileModal')" aria-label="ë‹«ê¸°">&times;</button>

      <div class="profile-top" aria-hidden="false">
        <img id="profileBanner" class="profile-banner" src="https://via.placeholder.com/720x160?text=Banner" alt="í”„ë¡œí•„ ë°°ë„ˆ">
        <div class="profile-top-inner">
          <img id="profileAvatar" class="profile-avatar profile-avatar" src="https://via.placeholder.com/68?text=?" alt="í”„ë¡œí•„ ì‚¬ì§„">
          <div class="profile-meta">
            <div class="profile-nick" id="profileNickname">ì‚¬ìš©ì</div>
            <div id="profileBio" class="profile-bio">ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
          <div class="profile-actions" style="margin-left:16px;">
            <button id="followBtn" class="follow-btn" style="display:none;">íŒ”ë¡œìš°</button>
          </div>
        </div>
      </div>

      <div class="profile-body" aria-live="polite">
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="profile-stats">
            <div class="stat" id="followersCount">íŒ”ë¡œì›Œ 0</div>
            <div class="stat" id="followingCount">íŒ”ë¡œì‰ 0</div>
          </div>
        </div>

        <div style="margin-top:6px;">
          <div style="font-weight:700; margin-bottom:6px;">í™œë™ íƒ­</div>
          <div style="font-size:13px; color:#bbb;">(ë©¤ë²„ì˜ í™œë™ ë°ì‹œë³´ë“œ íƒ­ì€ ìŠ¹ì¸ëœ IPì—ê²Œ ì œê³µë˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.)</div>
        </div>

        <div class="activity-note">í™œë™ ê´€ë ¨ ê¸°ëŠ¥ì€ í˜„ì¬ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.</div>
      </div>
    </div>
  </div>

  <!-- === footer (ì›ë³¸ê³¼ ë™ì¼) === -->
  <footer>
    <a href="library.html?section=terms">ì´ìš©ì•½ê´€</a> |
    <a href="library.html?section=privacy">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a> |
    <a href="library.html?section=server">ìœ í”¼ë“œ ìì‚° ë°ì´í„° ì„œë²„ ì§€ì¹¨</a> |
    <a href="library.html?section=notice">ë°´ë¸”ë¦¬ì˜¨ ìš´ì˜ë¶€ ê³ ì§€ ì‚¬í•­</a> |
    <a href="library.html?section=community">ì»¤ë®¤ë‹ˆí‹° ê°€ì´ë“œë¼ì¸</a>

    <div style="margin-top:9px;">
      ìœ í”¼ë“œëŠ” ë°´ë¸”ë¦¬ì˜¨ ì‚¬ í”„ë¡œê·¸ë¨ ê°œë°œ ë¶€ì„œ "ì—ë„ˆìì´ì €"ì˜ ê³µì‹ ì¸íŠ¸ë¼ë„· í”Œë«í¼ìœ¼ë¡œ, ëª¨ë“  ì‚¬ì´íŠ¸ ë‚´ ì •ë³´ëŠ” ì‚¬ì´íŠ¸ ìì‚°ì‚¬ì˜ ëª©ì ì— í•œí•´ ì œí•œë˜ê³  ê´€ë¦¬ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
    <div style="margin-top:9px;">
      ê²½ê¸°ë„ ìˆ˜ì›ì‹œ ë°´ë¸”ë¦¬ì˜¨ ìˆ˜ì› ì§€ë¶€ ë¯¸ê³µê°œ ìœ„ì¹˜<br>
      help@upid.org | ì˜¤í”ˆ ì†ŒìŠ¤ ë¼ì´ì„ ìŠ¤<br>
      Â©UPID Foundation.
    </div>

    <div style="margin-top:15px; display:flex; justify-content:center; flex-wrap:wrap; gap:15px;">
      <img src="https://i.imgur.com/cNs1Eg7.png" alt="Logo1" style="height:30px;">
      <img src="https://i.imgur.com/SF42CN6.png" alt="Logo2" style="height:30px;">
      <img src="https://i.imgur.com/2pz9w9f.png" alt="Logo3" style="height:30px;">
      <img src="https://i.imgur.com/SfRsyh4.png" alt="Logo4" style="height:30px;">
      <img src="https://i.imgur.com/IS5OcvD.png" alt="Logo5" style="height:30px;">
      <img src="https://i.imgur.com/7uI8nfn.png" alt="Logo6" style="height:30px;">
      <img src="https://i.imgur.com/yccwqmB.png" alt="Logo7" style="height:30px;">
      <img src="https://i.imgur.com/mHH406e.png" alt="Logo8" style="height:30px;">
      <img src="https://i.imgur.com/tc4GZfM.png" alt="Logo9" style="height:30px;">
      <div style="width:1px; height:30px; background:#444;"></div>
      <img src="https://i.imgur.com/cHJBLaF.png" alt="Logo10" style="height:30px;">
    </div>
  </footer>

  <!-- === ìŠ¤í¬ë¦½íŠ¸: Firebase ì´ˆê¸°í™”, Auth, Firestore, ê²Œì‹œê¸€/ëŒ“ê¸€/ì¢‹ì•„ìš” ë¡œì§ === -->
  <script type="module">
    // Firebase ëª¨ë“ˆ (ë²„ì „ì€ ì›ë³¸ì˜ authì™€ ë§ì¶° 10.12.2 ì‚¬ìš©)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp,
      setDoc,
      deleteDoc,
      updateDoc,
      increment,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- firebaseConfig (ì—ë€ë‹¤ ì œê³µ) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBJZle3txhhthWgaIWTTHzrLl4bkJqQye4",
      authDomain: "fast-gateway-290809.firebaseapp.com",
      projectId: "fast-gateway-290809",
      storageBucket: "fast-gateway-290809.firebasestorage.app",
      messagingSenderId: "640433110514",
      appId: "1:640433110514:web:8fe4fafc9a987b6a4b3f6b",
      measurementId: "G-2V57XWX7CW"
    };

    // ì´ˆê¸°í™”
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ì „ì—­ í˜„ì¬ ì‚¬ìš©ì ì°¸ì¡°
    let currentUser = null;
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateHeader(user);
      // ëŒ“ê¸€ ì…ë ¥ í™œì„±í™”/ë¹„í™œì„±í™”
      const commentInput = document.getElementById('commentInput');
      const commentSubmit = document.getElementById('commentSubmit');
      if (commentInput && commentSubmit) {
        if (user) {
          commentInput.disabled = false;
          commentInput.placeholder = "ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.";
        } else {
          commentInput.disabled = true;
          commentInput.placeholder = "ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ í›„ ì…ë ¥í•˜ì„¸ìš”.";
        }
      }
      // ì¢‹ì•„ìš”/ë¶ë§ˆí¬ ë²„íŠ¼ ìƒíƒœ ë Œë”ë§ì€ ë³„ë„ ë¦¬ìŠ¤ë„ˆê°€ ì²˜ë¦¬
      // í”„ë¡œí•„ ëª¨ë‹¬ íŒ”ë¡œìš° ë²„íŠ¼ ìƒíƒœë„ í•„ìš”ì‹œ ê°±ì‹  (ëª¨ë‹¬ ì—´ë¦´ ë•Œ ê°±ì‹ )
    });

    // --- ê³µí†µ UI í•¨ìˆ˜ (ì „ì—­ ë…¸ì¶œ) ---
    window.openModal = function(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "flex";
    };
    window.closeModal = function(id) {
      const el = document.getElementById(id);
      if (el) el.style.display = "none";
    };

    function updateHeader(user) {
      const userNameEl = document.getElementById("userName");
      const loginBtn = document.querySelector(".auth-buttons a[onclick*='loginModal']");
      const signupBtn = document.querySelector(".auth-buttons a[onclick*='signupModal']");
      const logoutBtn = document.getElementById("logoutBtn");

      if (user) {
        if (loginBtn) loginBtn.style.display = "none";
        if (signupBtn) signupBtn.style.display = "none";
        if (logoutBtn) logoutBtn.style.display = "inline-block";

        if (userNameEl) {
          const name = user.displayName || user.email || "ì‚¬ìš©ì";
          userNameEl.textContent = name;
          userNameEl.style.display = "inline-block";
        }
      } else {
        if (loginBtn) loginBtn.style.display = "inline-block";
        if (signupBtn) signupBtn.style.display = "inline-block";
        if (logoutBtn) logoutBtn.style.display = "none";

        if (userNameEl) {
          userNameEl.textContent = "";
          userNameEl.style.display = "none";
        }
      }
    }

    // --- íšŒì›ê°€ì… / ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ë°”ì¸ë”© ---
    document.getElementById("signupSubmit").addEventListener("click", async () => {
      const nickname = document.getElementById("signupNickname").value;
      const email = document.getElementById("signupEmail").value;
      const pass = document.getElementById("signupPass").value;
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
        await updateProfile(userCredential.user, { displayName: nickname });
        // optionally create users collection doc
        try {
          const userDocRef = doc(db, 'users', userCredential.user.uid);
          await setDoc(userDocRef, {
            displayName: nickname || null,
            email: email || null,
            photoURL: userCredential.user.photoURL || null,
            createdAt: serverTimestamp()
          }, { merge: true });
        } catch (_) { /* ignore */ }
        updateHeader(userCredential.user);
        alert("íšŒì›ê°€ì… ì™„ë£Œ!");
        closeModal("signupModal");
      } catch (error) {
        alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + error.message);
      }
    });

    document.getElementById("loginSubmit").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, pass);
        updateHeader(userCredential.user);
        alert("ë¡œê·¸ì¸ ì„±ê³µ!");
        closeModal("loginModal");
      } catch (error) {
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await signOut(auth);
        updateHeader(null);
      } catch (e) {
        console.error(e);
      }
    });

    // --- ê²Œì‹œê¸€ / ëŒ“ê¸€ / ì¢‹ì•„ìš” ë¡œì§ (ë™ì  post ì„ íƒ ì§€ì›) ---
    // ìš°ì„ ìˆœìœ„: URL ?id=XXX  -> localStorage 'selectedPostId' -> ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ID
    let currentPostId = (new URLSearchParams(window.location.search).get('id')) 
                        || (localStorage.getItem('selectedPostId')) 
                        || "osQ0GPHi5GRRFOIRNpW0";

    // í˜„ì¬ ê²Œì‹œê¸€ì˜ authorId (í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸°ìš©)
    let currentAuthorId = null;

    // UI: ê´€ë¦¬ì ì…ë ¥ ì»¨íŠ¸ë¡¤
    const adminInput = document.getElementById('adminPostIdInput');
    const adminSetBtn = document.getElementById('adminSetBtn');
    const adminClearBtn = document.getElementById('adminClearBtn');

    // ì´ˆê¸° ê´€ë¦¬ì input ê°’
    if (adminInput) adminInput.value = currentPostId || '';

    adminSetBtn.addEventListener('click', async () => {
      const v = (adminInput.value || '').trim();
      if (!v) { alert('ë¬¸ì„œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
      try {
        await setCurrentPostId(v);
        // ë°˜ì˜ë˜ì—ˆìŒì„ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì¤Œ
        adminInput.value = currentPostId;
      } catch (e) {
        console.error(e);
        alert('ë¬¸ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    adminClearBtn.addEventListener('click', async () => {
      localStorage.removeItem('selectedPostId');
      // if URL had id param, remove it
      const url = new URL(window.location.href);
      url.searchParams.delete('id');
      history.replaceState({}, '', url.toString());
      // set to default
      await setCurrentPostId("osQ0GPHi5GRRFOIRNpW0");
      adminInput.value = currentPostId;
    });

    // í•¨ìˆ˜: ë³€ê²½ ì ìš© (asyncë¡œ ë§Œë“¤ì–´ initPostê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆìŒ)
    async function setCurrentPostId(newId) {
      if (!newId) return;
      // save to localStorage
      localStorage.setItem('selectedPostId', newId);
      // update URL param without reload
      const url = new URL(window.location.href);
      url.searchParams.set('id', newId);
      history.replaceState({}, '', url.toString());
      // update variable
      currentPostId = newId;
      // refresh UI and listeners (initPostëŠ” ë‚´ë¶€ì ìœ¼ë¡œ getDocì„ ê¸°ë‹¤ë¦¼)
      await initPost();
    }

    // UI ìš”ì†Œ
    const titleEl = document.getElementById('title');
    const contentEl = document.getElementById('content');
    const authorEl = document.getElementById('author');
    const createdAtEl = document.getElementById('createdAt');
    const authorAvatarEl = document.getElementById('authorAvatar');
    const galleryEl = document.getElementById('imageGallery');

    const postLikeBtn = document.getElementById('postLikeBtn');
    const postLikeLabel = document.getElementById('postLikeLabel');
    const postLikeCountEl = document.getElementById('postLikeCount');
    const postBookmarkBtn = document.getElementById('postBookmarkBtn');
    const postBookmarkLabel = document.getElementById('postBookmarkLabel');
    const postBookmarkCountEl = document.getElementById('postBookmarkCount');
    const postViewCountEl = document.getElementById('postViewCount');

    const commentInput = document.getElementById('commentInput');
    const commentSubmit = document.getElementById('commentSubmit');
    const commentsList = document.getElementById('commentsList');
    const commentsCountEl = document.getElementById('commentsCount');

    // ìƒíƒœ ë° ë¦¬ìŠ¤ë„ˆ í•´ì œ í•¸ë“¤
    let postLikeListenerUnsub = null;
    let commentsListenerUnsub = null;
    let postBookmarkListenerUnsub = null;
    let postLikedByCurrentUser = false;
    let postBookmarkedByCurrentUser = false;

    // Load post data once and set up listeners (ì•ˆì „: ì´ì „ ë¦¬ìŠ¤ë„ˆ í•´ì œ)
    async function initPost() {
      // unsubscribe previous listeners (if any)
      try {
        if (postLikeListenerUnsub) { postLikeListenerUnsub(); postLikeListenerUnsub = null; }
        if (commentsListenerUnsub) { commentsListenerUnsub(); commentsListenerUnsub = null; }
        if (postBookmarkListenerUnsub) { postBookmarkListenerUnsub(); postBookmarkListenerUnsub = null; }
      } catch (e) { /* ignore */ }

      // clear UI while loading
      titleEl.innerText = 'ë¡œë”© ì¤‘...';
      contentEl.innerText = '';
      authorEl.innerText = '';
      createdAtEl.innerText = '';
      authorAvatarEl.src = 'https://via.placeholder.com/48?text=?';
      galleryEl.innerHTML = '';
      commentsList.innerHTML = '';
      commentsCountEl.innerText = '0';
      postLikeCountEl.innerText = '0';
      postBookmarkCountEl.innerText = '0';
      postViewCountEl.innerText = '';
      postLikedByCurrentUser = false;
      postBookmarkedByCurrentUser = false;
      renderPostLikeButton();
      renderPostBookmarkButton();

      try {
        const postDocRef = doc(db, 'gaesi', currentPostId);
        const snap = await getDoc(postDocRef);
        if (!snap.exists()) {
          titleEl.innerText = 'ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
          contentEl.innerText = '';
          postViewCountEl.innerText = '';
          return;
        }
        const data = snap.data();

        titleEl.innerText = data.title || '(ì œëª© ì—†ìŒ)';

        // ì‘ì„±ì ì •ë³´: data.authorId ìš°ì„  -> users ì»¬ë ‰ì…˜ ì¡°íšŒ
        let authorName = data.author || '';
        let authorProfile = data.authorProfileUrl || '';
        currentAuthorId = data.authorId || null;
        if (data.authorId) {
          try {
            const userDoc = await getDoc(doc(db, 'users', data.authorId));
            if (userDoc.exists()) {
              const userData = userDoc.data();
              authorName = userData.displayName || authorName || userData.email || '';
              authorProfile = userData.photoURL || authorProfile || '';
            }
          } catch (e) { /* ignore */ }
        }
        // author display with possible notice tag
        authorEl.innerHTML = '';
        const nameNode = document.createElement('span');
        nameNode.textContent = authorName ? `${authorName}` : '';
        nameNode.style.cursor = 'pointer';
        nameNode.addEventListener('click', (ev) => { ev.stopPropagation(); openProfileModalFor(currentAuthorId); });
        authorEl.appendChild(nameNode);

        // show notice tag if post is notice (data.notice === true or data.isNotice)
        const isNotice = data.notice === true || data.isNotice === true || data.isPinned === true;
        if (isNotice) {
          const tag = document.createElement('span');
          tag.className = 'role-tag';
          tag.style.marginLeft = '8px';
          tag.textContent = 'ê³µì§€';
          authorEl.appendChild(tag);
        }

        if (authorProfile) {
          authorAvatarEl.src = authorProfile;
        } else {
          authorAvatarEl.src = 'https://via.placeholder.com/48?text=?';
        }

        // createdAt
        if (data.createdAt) {
          let date;
          if (typeof data.createdAt.toDate === 'function') {
            date = data.createdAt.toDate();
          } else {
            date = new Date(data.createdAt);
          }
          createdAtEl.innerText = date && !isNaN(date.getTime()) ? date.toLocaleString() : '';
        } else {
          createdAtEl.innerText = '';
        }

        // viewCount í‘œì‹œ (ì„œë²„ í•„ë“œ: viewCount)
        const viewCountVal = (typeof data.viewCount === 'number') ? data.viewCount : 0;
        postViewCountEl.innerText = `ì¡°íšŒìˆ˜ ${viewCountVal}`;

        // content
        if (data.contentHtml) {
          contentEl.innerHTML = data.contentHtml;
        } else {
          contentEl.innerText = data.content || '(ë‚´ìš© ì—†ìŒ)';
        }

        // images - make them full width and keep aspect ratio; rounded corners preserved
        galleryEl.innerHTML = '';
        if (data.imageUrls && Array.isArray(data.imageUrls) && data.imageUrls.length) {
          data.imageUrls.slice(0,6).forEach((u,i) => {
            const img = document.createElement('img');
            img.src = u;
            img.alt = `ì´ë¯¸ì§€ ${i+1}`;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.border = '1px solid rgba(255,255,255,0.04)';
            img.loading = 'lazy';
            galleryEl.appendChild(img);
          });
        } else if (data.imageUrl) {
          const img = document.createElement('img');
          img.src = data.imageUrl;
          img.alt = 'ì´ë¯¸ì§€';
          img.style.width = '100%';
          img.style.height = 'auto';
          img.style.objectFit = 'cover';
          img.style.borderRadius = '8px';
          img.style.border = '1px solid rgba(255,255,255,0.04)';
          img.loading = 'lazy';
          galleryEl.appendChild(img);
        }

        // author avatar/name click: open profile modal
        const authorBlock = document.getElementById('authorBlock');
        if (authorBlock) {
          authorBlock.onclick = () => openProfileModalFor(currentAuthorId);
          authorBlock.onkeypress = (ev) => { if (ev.key === 'Enter') openProfileModalFor(currentAuthorId); };
        }

        // set up likes listener (count + whether currentUser liked)
        setupPostLikesListener();

        // set up bookmarks listener (count + whether currentUser bookmarked)
        setupPostBookmarksListener();

        // set up comments real-time listener
        setupCommentsListener();

        // increment viewCount on first view this session (sessionStorage ê¸°ë°˜)
        try {
          const viewedKey = `viewed_post_${currentPostId}`;
          if (!sessionStorage.getItem(viewedKey)) {
            // increment server-side
            try {
              await updateDoc(postDocRef, { viewCount: increment(1) });
              // reflect change in UI (optimistic)
              const newVal = viewCountVal + 1;
              postViewCountEl.innerText = `ì¡°íšŒìˆ˜ ${newVal}`;
            } catch (e) {
              // update ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ(ë„¤íŠ¸ì›Œí¬ ë“±), UIëŠ” ì„œë²„ ìƒíƒœ ê·¸ëŒ€ë¡œ ìœ ì§€
              console.error('viewCount update failed', e);
            }
            sessionStorage.setItem(viewedKey, '1');
          }
        } catch (e) {
          // sessionStorage ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
          console.error(e);
        }

        // ì™„ë£Œ
        return;
      } catch (err) {
        console.error(err);
        titleEl.innerText = 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        contentEl.innerText = '';
        postViewCountEl.innerText = '';
        throw err;
      }
    }

    // --- Post Likes ---
    function setupPostLikesListener() {
      const likesCol = collection(db, 'gaesi', currentPostId, 'likes');
      if (postLikeListenerUnsub) postLikeListenerUnsub();
      postLikeListenerUnsub = onSnapshot(likesCol, (snap) => {
        const likeCount = snap.size;
        postLikeCountEl.innerText = likeCount;
        // check if current user liked
        if (currentUser) {
          const meLiked = snap.docs.some(d => d.id === currentUser.uid);
          postLikedByCurrentUser = meLiked;
          renderPostLikeButton();
        } else {
          postLikedByCurrentUser = false;
          renderPostLikeButton();
        }
      }, (err) => {
        console.error('post likes listener error', err);
      });
    }

    function renderPostLikeButton() {
      if (postLikedByCurrentUser) {
        postLikeLabel.innerText = 'â™¥ ì¢‹ì•„ìš” ì·¨ì†Œ';
        postLikeBtn.classList.add('btn');
        postLikeBtn.style.color = '#ffae42';
      } else {
        postLikeLabel.innerText = 'â™¡ ì¢‹ì•„ìš”';
        postLikeBtn.style.color = '';
      }
    }

    postLikeBtn.addEventListener('click', async () => {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      const userLikeRef = doc(db, 'gaesi', currentPostId, 'likes', currentUser.uid);
      try {
        const existsSnap = await getDoc(userLikeRef);
        if (existsSnap.exists()) {
          // unlike
          await deleteDoc(userLikeRef);
        } else {
          // like
          await setDoc(userLikeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
        }
        // listener will update UI
      } catch (e) {
        console.error(e);
      }
    });

    // --- Post Bookmarks (ìƒˆë¡œ ì¶”ê°€: ì¢‹ì•„ìš”ì™€ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ ì„œë²„ì— ì €ì¥) ---
    function setupPostBookmarksListener() {
      const bookmarksCol = collection(db, 'gaesi', currentPostId, 'bookmarks');
      if (postBookmarkListenerUnsub) postBookmarkListenerUnsub();
      postBookmarkListenerUnsub = onSnapshot(bookmarksCol, (snap) => {
        const bookmarkCount = snap.size;
        postBookmarkCountEl.innerText = bookmarkCount;
        if (currentUser) {
          const meBookmarked = snap.docs.some(d => d.id === currentUser.uid);
          postBookmarkedByCurrentUser = meBookmarked;
          renderPostBookmarkButton();
        } else {
          postBookmarkedByCurrentUser = false;
          renderPostBookmarkButton();
        }
      }, (err) => {
        console.error('post bookmarks listener error', err);
      });
    }

    function renderPostBookmarkButton() {
      if (postBookmarkedByCurrentUser) {
        postBookmarkLabel.innerText = 'ğŸ”– ë¶ë§ˆí¬ í•´ì œ';
        postBookmarkBtn.style.color = '#ffae42';
      } else {
        postBookmarkLabel.innerText = 'ğŸ”– ë¶ë§ˆí¬';
        postBookmarkBtn.style.color = '';
      }
    }

    postBookmarkBtn.addEventListener('click', async () => {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      const userBookmarkRef = doc(db, 'gaesi', currentPostId, 'bookmarks', currentUser.uid);
      try {
        const existsSnap = await getDoc(userBookmarkRef);
        if (existsSnap.exists()) {
          // remove bookmark
          await deleteDoc(userBookmarkRef);
        } else {
          // add bookmark
          await setDoc(userBookmarkRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
        }
      } catch (e) {
        console.error(e);
      }
    });

    // --- Comments: add + real-time render + comment likes ---
    function setupCommentsListener() {
      const commentsCol = collection(db, 'gaesi', currentPostId, 'comments');
      const q = query(commentsCol, orderBy('createdAt', 'asc'));
      if (commentsListenerUnsub) commentsListenerUnsub();
      commentsListenerUnsub = onSnapshot(q, (snapshot) => {
        commentsList.innerHTML = '';
        commentsCountEl.innerText = `${snapshot.size}`;
        snapshot.forEach(docSnap => {
          const c = docSnap.data();
          const id = docSnap.id;
          const item = renderCommentItem(id, c);
          commentsList.appendChild(item);
          // For each comment, we will render its like count from c.likeCount (kept in doc) and check if current user liked
        });
      }, (err) => {
        console.error('comments listener error', err);
      });
    }

    function renderCommentItem(commentId, commentData) {
      const div = document.createElement('div');
      div.className = 'comment-item';
      // avatar
      const avatar = document.createElement('img');
      avatar.className = 'comment-author-avatar';
      avatar.src = commentData.authorProfileUrl || 'https://via.placeholder.com/40?text=?';
      avatar.alt = 'í”„ë¡œí•„';
      // body
      const body = document.createElement('div');
      body.className = 'comment-body';

      const head = document.createElement('div');
      head.className = 'comment-head';
      const name = document.createElement('div');
      name.className = 'comment-author-name';
      name.innerText = commentData.authorName || 'ìµëª…';
      const date = document.createElement('div');
      date.className = 'comment-date';
      if (commentData.createdAt) {
        let d;
        if (typeof commentData.createdAt.toDate === 'function') d = commentData.createdAt.toDate();
        else d = new Date(commentData.createdAt);
        date.innerText = d && !isNaN(d.getTime()) ? d.toLocaleString() : '';
      } else date.innerText = '';

      head.appendChild(name);
      head.appendChild(date);

      const content = document.createElement('div');
      content.className = 'comment-content';
      content.innerText = commentData.content || '';

      const actions = document.createElement('div');
      actions.className = 'comment-actions';

      // like button for comment
      const likeBtn = document.createElement('button');
      likeBtn.className = 'like-btn';
      likeBtn.innerHTML = `â™¡ <span class="c-like-count">${commentData.likeCount || 0}</span>`;
      likeBtn.title = 'ê³µê°';

      // check if current user liked this comment
      async function refreshCommentLikeState() {
        if (!currentUser) {
          likeBtn.classList.remove('liked');
          return;
        }
        try {
          const likeDoc = await getDoc(doc(db, 'gaesi', currentPostId, 'comments', commentId, 'likes', currentUser.uid));
          if (likeDoc.exists()) likeBtn.classList.add('liked');
          else likeBtn.classList.remove('liked');
        } catch (e) {
          // ignore
        }
      }
      // initial state
      refreshCommentLikeState();

      // click handler
      likeBtn.addEventListener('click', async () => {
        if (!currentUser) {
          openModal('loginModal');
          return;
        }
        const likeRef = doc(db, 'gaesi', currentPostId, 'comments', commentId, 'likes', currentUser.uid);
        const commentDocRef = doc(db, 'gaesi', currentPostId, 'comments', commentId);
        try {
          const existing = await getDoc(likeRef);
          if (existing.exists()) {
            // unlike
            await deleteDoc(likeRef);
            // decrement likeCount if field exists
            try { await updateDoc(commentDocRef, { likeCount: increment(-1) }); } catch (_) {}
            // update UI immediately
            const countSpan = likeBtn.querySelector('.c-like-count');
            if (countSpan) countSpan.innerText = Math.max(0, (commentData.likeCount || 0) - 1);
            likeBtn.classList.remove('liked');
          } else {
            // like
            await setDoc(likeRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
            try { await updateDoc(commentDocRef, { likeCount: increment(1) }); } catch (_) {}
            const countSpan = likeBtn.querySelector('.c-like-count');
            if (countSpan) countSpan.innerText = (commentData.likeCount || 0) + 1;
            likeBtn.classList.add('liked');
          }
        } catch (e) {
          console.error(e);
        }
      });

      actions.appendChild(likeBtn);

      body.appendChild(head);
      body.appendChild(content);
      body.appendChild(actions);

      div.appendChild(avatar);
      div.appendChild(body);

      return div;
    }

    // submit comment
    commentSubmit.addEventListener('click', async () => {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      const text = commentInput.value && commentInput.value.trim();
      if (!text) {
        alert('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      try {
        // get author info from users col if exists
        let authorName = currentUser.displayName || currentUser.email || 'ì‚¬ìš©ì';
        let authorProfile = currentUser.photoURL || '';

        try {
          const uDoc = await getDoc(doc(db, 'users', currentUser.uid));
          if (uDoc.exists()) {
            const ud = uDoc.data();
            authorName = ud.displayName || authorName;
            authorProfile = ud.photoURL || authorProfile;
          }
        } catch (e) { /* ignore */ }

        const commentsCol = collection(db, 'gaesi', currentPostId, 'comments');
        await addDoc(commentsCol, {
          authorId: currentUser.uid,
          authorName,
          authorProfileUrl: authorProfile || '',
          content: text,
          createdAt: serverTimestamp(),
          likeCount: 0
        });
        commentInput.value = '';
        // listener will show it
      } catch (e) {
        console.error(e);
        alert('ëŒ“ê¸€ ì‘ì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    // --- Profile modal functionality (users ì»¬ë ‰ì…˜ ê¸°ë°˜) ---
    const profileModal = document.getElementById('profileModal');
    const profileBanner = document.getElementById('profileBanner');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileNickname = document.getElementById('profileNickname');
    const profileBio = document.getElementById('profileBio');
    const followersCountEl = document.getElementById('followersCount');
    const followingCountEl = document.getElementById('followingCount');
    const followBtn = document.getElementById('followBtn');

    // open profile modal for a given userId
    async function openProfileModalFor(userId) {
      if (!userId) {
        alert('í•´ë‹¹ ì‚¬ìš©ìì˜ í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      try {
        await loadProfileIntoModal(userId);
        openModal('profileModal');
      } catch (e) {
        console.error(e);
        alert('í”„ë¡œí•„ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // load user data into profile modal and setup follow button
    async function loadProfileIntoModal(userId) {
      // reset UI
      profileBanner.src = 'https://via.placeholder.com/720x160?text=Banner';
      profileAvatar.src = 'https://via.placeholder.com/68?text=?';
      profileNickname.textContent = 'ì‚¬ìš©ì';
      profileBio.textContent = '';
      followersCountEl.textContent = 'íŒ”ë¡œì›Œ 0';
      followingCountEl.textContent = 'íŒ”ë¡œì‰ 0';
      followBtn.style.display = 'none';
      followBtn.textContent = 'íŒ”ë¡œìš°';

      // fetch user doc
      const userRef = doc(db, 'users', userId);
      const uSnap = await getDoc(userRef);
      if (!uSnap.exists()) {
        profileNickname.textContent = 'ì‚¬ìš©ì';
        profileBio.textContent = '(ì •ë³´ ì—†ìŒ)';
        return;
      }
      const udata = uSnap.data();

      // banner & avatar
      const bannerUrl = udata.bannerUrl || udata.coverPhoto || '';
      const avatarUrl = udata.photoURL || udata.avatarUrl || '';
      if (bannerUrl) profileBanner.src = bannerUrl;
      if (avatarUrl) profileAvatar.src = avatarUrl;

      profileNickname.textContent = udata.displayName || udata.nickname || udata.email || 'ì‚¬ìš©ì';
      profileBio.textContent = udata.bio || udata.description || '';

      // role tag: if admin or role field present
      // show small tag next to nickname if admin
      const role = udata.role || '';
      // remove existing role tag if any
      const existingRoleTag = profileNickname.querySelector('.profile-role');
      if (existingRoleTag) existingRoleTag.remove();
      if (role && role.toLowerCase() === 'admin') {
        const span = document.createElement('span');
        span.className = 'profile-role';
        span.textContent = 'ìš´ì˜ì';
        profileNickname.appendChild(span);
      }

      // follower/following counts: prefer stored fields, else count subcollections
      let followerCount = (typeof udata.followerCount === 'number') ? udata.followerCount : null;
      let followingCount = (typeof udata.followingCount === 'number') ? udata.followingCount : null;

      if (followerCount === null) {
        try {
          const docs = await getDocs(collection(db, 'users', userId, 'followers'));
          followerCount = docs.size;
        } catch (e) {
          followerCount = 0;
        }
      }
      if (followingCount === null) {
        try {
          const docs2 = await getDocs(collection(db, 'users', userId, 'following'));
          followingCount = docs2.size;
        } catch (e) {
          followingCount = 0;
        }
      }
      followersCountEl.textContent = `íŒ”ë¡œì›Œ ${followerCount}`;
      followingCountEl.textContent = `íŒ”ë¡œì‰ ${followingCount}`;

      // Follow button: do not show for own profile
      if (!currentUser || currentUser.uid === userId) {
        followBtn.style.display = 'none';
      } else {
        followBtn.style.display = 'inline-block';
        // check if currentUser follows this user
        try {
          const relDoc = await getDoc(doc(db, 'users', currentUser.uid, 'following', userId));
          if (relDoc.exists()) {
            followBtn.textContent = 'ì–¸íŒ”ë¡œìš°';
            followBtn.dataset.following = '1';
          } else {
            followBtn.textContent = 'íŒ”ë¡œìš°';
            followBtn.dataset.following = '0';
          }
        } catch (e) {
          followBtn.textContent = 'íŒ”ë¡œìš°';
          followBtn.dataset.following = '0';
        }
      }

      // attach follow handler
      followBtn.onclick = async (ev) => {
        ev.stopPropagation();
        if (!currentUser) {
          openModal('loginModal');
          return;
        }
        try {
          const amFollowing = followBtn.dataset.following === '1';
          const followingRef = doc(db, 'users', currentUser.uid, 'following', userId);
          const followerRef = doc(db, 'users', userId, 'followers', currentUser.uid);
          const userDocRef = doc(db, 'users', userId);
          const myDocRef = doc(db, 'users', currentUser.uid);

          if (amFollowing) {
            // unfollow: remove both docs and decrement counts
            await deleteDoc(followingRef);
            await deleteDoc(followerRef);
            try { await updateDoc(userDocRef, { followerCount: increment(-1) }); } catch (_) {}
            try { await updateDoc(myDocRef, { followingCount: increment(-1) }); } catch (_) {}
            followBtn.textContent = 'íŒ”ë¡œìš°';
            followBtn.dataset.following = '0';
            // update counts in UI
            const currentFollowers = parseInt((followersCountEl.textContent || '').replace(/[^0-9]/g,'')) || 0;
            const currentFollowing = parseInt((followingCountEl.textContent || '').replace(/[^0-9]/g,'')) || 0;
            followersCountEl.textContent = `íŒ”ë¡œì›Œ ${Math.max(0, currentFollowers - 1)}`;
            // We don't change the target user's following count here; it's for currentUser only
          } else {
            // follow: create both docs and increment counts
            await setDoc(followingRef, { uid: userId, createdAt: serverTimestamp() });
            await setDoc(followerRef, { uid: currentUser.uid, createdAt: serverTimestamp() });
            try { await updateDoc(userDocRef, { followerCount: increment(1) }); } catch (_) {}
            try { await updateDoc(myDocRef, { followingCount: increment(1) }); } catch (_) {}
            followBtn.textContent = 'ì–¸íŒ”ë¡œìš°';
            followBtn.dataset.following = '1';
            const currentFollowers = parseInt((followersCountEl.textContent || '').replace(/[^0-9]/g,'')) || 0;
            followersCountEl.textContent = `íŒ”ë¡œì›Œ ${currentFollowers + 1}`;
          }
        } catch (e) {
          console.error(e);
          alert('íŒ”ë¡œìš° ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };
    }

    // init (ì²˜ìŒ ë¡œë“œ ì‹œ í˜„ì¬ IDë¡œ ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜´)
    initPost();

    // ëª¨ë‹¬ ê°„ ì „í™˜ ë²„íŠ¼
    document.getElementById('openSignupFromLogin').addEventListener('click', () => {
      closeModal('loginModal');
      openModal('signupModal');
    });
    document.getElementById('openLoginFromSignup').addEventListener('click', () => {
      closeModal('signupModal');
      openModal('loginModal');
    });

  </script>

  <!-- non-module scripts: pw-toggle ë™ì‘ ë° ëª¨ë‹¬ í´ë¦­ ì´ì™¸ ë‹«ê¸° ì²˜ë¦¬ (ì›ë³¸ ë™ì‘ê³¼ ë™ì¼) -->
  <script>
    (function(){
      document.querySelectorAll('.pw-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
          const targetId = btn.getAttribute('data-target');
          if (!targetId) return;
          const input = document.getElementById(targetId);
          if (!input) return;

          if (input.type === 'password') {
            input.type = 'text';
            const eye = btn.querySelector('.icon-eye');
            const eyeOff = btn.querySelector('.icon-eye-off');
            if (eye) eye.style.display = 'none';
            if (eyeOff) eyeOff.style.display = 'block';
            btn.setAttribute('aria-pressed','true');
            btn.title = "ë¹„ë°€ë²ˆí˜¸ ìˆ¨ê¸°ê¸°";
          } else {
            input.type = 'password';
            const eye = btn.querySelector('.icon-eye');
            const eyeOff = btn.querySelector('.icon-eye-off');
            if (eye) eye.style.display = 'block';
            if (eyeOff) eyeOff.style.display = 'none';
            btn.setAttribute('aria-pressed','false');
            btn.title = "ë¹„ë°€ë²ˆí˜¸ ë³´ê¸°";
          }
        });
      });

      // close modal when clicking outside content
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (ev) => {
          if (ev.target === modal) modal.style.display = 'none';
        });
      });
    })();
  </script>

</body>
</html>
